<div class="bg-white p-8 rounded-lg shadow-lg w-full mx-auto">
    <!-- Run Creation Form -->
    <form method="post" class="space-y-6" action="{% url 'hub:pages:run:update' run.id %}?from_modal={{ from_modal }}">
        {% csrf_token %}
        <div class="grid grid-cols-3 gap-4">
            {% for field in form %}
                <div class="relative mb-6">
                    {{ field.label_tag }} {{ field }}
                    {{ field.errors }}
                    {% if field.help_text %}<p class="help">{{ field.help_text|safe }}</p>{% endif %}
                </div>
            {% endfor %}
        </div>
        <!-- Submit Button -->
        <button type="submit" class="bg-primary text-white p-3 w-full text-xl">Update</button>
    </form>
</div>
<script>
    $(document).ready(function() {
        // Initialize dropdowns
        $('.ui.dropdown').dropdown();

        // Setup change handler for hub dropdown
        $('#id_hub').change(function () {
            const hubId = $(this).val();
            const currentVendorId = $('#id_vendor').val();
            const $vendorSelect = $('#id_vendor');
            
            if (hubId) {
                $.ajax({
                    url: "{% url 'hub:pages:run:get_hub_vendors' %}",
                    type: "GET",
                    data: { hub_id: hubId },
                    success: function (response) {
                        
                        // Clear and update vendor dropdown
                        $vendorSelect.empty();
                        $vendorSelect.append('<option value="">Select vendor</option>');
                        response['vendors'].forEach(function(vendor) {
                            $vendorSelect.append(
                                $('<option>', { value: vendor.id, text: vendor.info })
                            );
                        });
                        $vendorSelect.dropdown('refresh');

                        // Check if current vendor is still valid for the new hub
                        const currentVendorValid = response['vendors'].some(vendor => vendor.id == currentVendorId);
                        if (currentVendorValid) {
                            $vendorSelect.dropdown('set selected', currentVendorId);
                        } else {
                            $vendorSelect.dropdown('clear');
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Error fetching vendors:', error);
                    }
                });
            } else {
                // Clear vendor dropdown if no hub selected
                $('#id_vendor').dropdown('clear');
                $('#id_vendor').dropdown('setup menu', { values: [] });
                $('#id_vendor').dropdown('refresh');
            }
        });

        // Initialize vendor dropdown based on initial hub value
        const initialHubId = $('#id_hub').val();
        if (initialHubId) {
            $('#id_hub').trigger('change');
        }
    });
</script>
