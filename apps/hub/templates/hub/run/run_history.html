{% extends "base.html" %}
{% block title %} {{ title }} {% endblock title %}

{% block pagetitle %}{{ run }} History{% endblock %}

{% block content %}
{% csrf_token %}
    <style>
    /* Ensure search row is not clickable */
    #search-row td {
        pointer-events: auto !important;
    }
    </style>
    <!-- Data Table -->
    <div class="bg-white p-5">
        <div class="overflow-x-auto">
            <table id="dataTable"
                   class="display min-w-full border-collapse border border-gray-300 w-full">
                <thead class="bg-gray-200">
                    <tr class="bg-primary text-white">
                        <th class="p-3 border">SN</th>
                        <th class="p-3 border">Model</th>
                        <th class="p-3 border">AWB</th>
                        <th class="p-3 border">Date/Time</th>
                        <th class="p-3 border">Changed By</th>
                        <th class="p-3 border">Type</th>
                        <th class="p-3 border">Changes</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be populated dynamically via DataTables -->
                </tbody>
            </table>
        </div>
    </div>
{% endblock %}

{% block js %}
<script>
    $(document).ready(function() {
        if ($.fn.DataTable.isDataTable('#dataTable')) {
            $('#dataTable').DataTable().destroy();
        }
        
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        $('#dataTable').DataTable({
            processing: true,
            serverSide: true,
            ajax: {
                url: "{% url 'hub:pages:run:run_history' run_id=run.id %}",
                type: "POST",
                data: function(d) {
                    d.csrfmiddlewaretoken = csrftoken;
                    return d;
                },
                beforeSend: function(xhr) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                },
                dataSrc: 'data',
            },
            columns: [
                { 
                    data: function (data, type, row, meta) {
                        return meta.row + meta.settings._iDisplayStart + 1;
                    },
                    name: "sn", 
                    searchable: false 
                },
                { data: 'model' },
                { data: 'awb' },
                { data: 'date' },
                { data: 'changed_by' },
                { data: 'history_type' },
                { 
                    data: 'changes', 
                    render: function(data, type, row) {
                        if (typeof data === 'object') {
                            let changes = [];
                            for (let [field, values] of Object.entries(data)) {
                                if (typeof values === 'object' && values.old && values.new) {
                                    if (typeof values.old === 'object' && typeof values.new === 'object') {
                                        // Handle nested objects (for foreign key changes)
                                        let oldStr = Object.entries(values.old)
                                            .map(([k, v]) => `${k}: ${v}`)
                                            .join(', ');
                                        let newStr = Object.entries(values.new)
                                            .map(([k, v]) => `${k}: ${v}`)
                                            .join(', ');
                                        changes.push(`${field}: ${oldStr} → ${newStr}`);
                                    } else {
                                        changes.push(`${field}: ${values.old} → ${values.new}`);
                                    }
                                }
                            }
                            return changes.join('<br>');
                        }
                        return data;
                    }
                }
            ],
            order: [[3, 'desc']] // Sort by date column descending
        });
    });
</script>
{% endblock %}