{% extends "base.html" %}
{% block title %} {{ title }} {% endblock title %}

{% block pagetitle %}AWB API Responses{% endblock %}

{% block content %}
    <style>
        /* Custom styles for API responses table */
        .status-badge {
            border-radius: 9999px;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .success-badge {
            background-color: #D1FAE5;
            color: #065F46;
        }
        
        .failed-badge {
            background-color: #FEE2E2;
            color: #991B1B;
        }
        
        .action-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background-color: #3B82F6;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2563EB;
        }
        
        .btn-success {
            background-color: #10B981;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #059669;
        }
        
        .btn-info {
            background-color: #06B6D4;
            color: white;
        }
        
        .btn-info:hover {
            background-color: #0891B2;
        }
        
        /* DataTables custom styling */
        .dataTables_wrapper .dataTables_length,
        .dataTables_wrapper .dataTables_filter,
        .dataTables_wrapper .dataTables_info,
        .dataTables_wrapper .dataTables_paginate {
            margin: 1rem 0;
        }
        
        .dataTables_wrapper .dataTables_paginate .paginate_button {
            padding: 0.5rem 1rem;
            margin: 0 0.25rem;
            border-radius: 0.375rem;
            border: 1px solid #D1D5DB;
            background: white;
            color: #374151;
        }
        
        .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
            background: #F3F4F6;
            border-color: #9CA3AF;
        }
        
        .dataTables_wrapper .dataTables_paginate .paginate_button.current {
            background: #3B82F6;
            color: white;
            border-color: #3B82F6;
        }
    </style>

    <!-- Header Section -->
    <div class="bg-white p-6 mb-6 rounded-lg shadow-sm border">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">AWB API Responses</h1>
                
            </div>
            <div class="flex items-center gap-3">
                <!-- Filter dropdown -->
                 {% comment %} from date and to date {% endcomment %}
                <p class="text-gray-600 mt-1">From Date</p>
                <input type="date" id="fromDate" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <p class="text-gray-600 mt-1">To Date</p>
                <input type="date" id="toDate" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <select id="statusFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All Status</option>
                    <option value="success">Success</option>
                    <option value="failure">Failure</option>
                    <option value="failure_with_ref">Failure with Reference No</option>
                </select>
                <select id="vendorFilter" class="px-3 mx-2 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All Vendors</option>
                    <option value="SGAU">SGAU</option>
                    <option value="SGCA">SGCA</option>
                    <option value="SGUS">SGUS</option>
                    <option value="COURIERX">COURIERX</option>
                    <option value="UBX">UBX</option>
                    <option value="DTDC">DTDC</option>
                </select>
                
                <!-- Refresh button -->
                <button id="refreshBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors">
                    <i class="fi fi-rr-refresh text-sm"></i>
                    <span>Refresh</span>
                </button>
                <button id="exportBtn" class="bg-green-600 hover:bg-green-700 hover:text-white text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors">
                    <i class="fi fi-rr-file-export text-sm"></i>
                    <span>Export</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
        <div class="bg-white p-6 rounded-lg shadow-sm border">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600">Total Responses</p>
                    <p class="text-2xl font-bold text-gray-900" id="totalCount">-</p>
                </div>
                <div class="bg-blue-100 p-3 rounded-full">
                    <i class="fi fi-rr-stats text-blue-600 text-xl"></i>
                </div>
            </div>
        </div>
        
        <div class="bg-white p-6 rounded-lg shadow-sm border">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600">Success Rate</p>
                    <p class="text-2xl font-bold text-green-600" id="successRate">-</p>
                </div>
                <div class="bg-green-100 p-3 rounded-full">
                    <i class="fi fi-rr-check text-green-600 text-xl"></i>
                </div>
            </div>
        </div>
        
        <div class="bg-white p-6 rounded-lg shadow-sm border">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600">Failed w/ Ref</p>
                    <p class="text-2xl font-bold text-orange-600" id="failedWithRefCount">-</p>
                </div>
                <div class="bg-orange-100 p-3 rounded-full">
                    <i class="fi fi-rr-exclamation text-orange-600 text-xl"></i>
                </div>
            </div>
        </div>
        
        <div class="bg-white p-6 rounded-lg shadow-sm border">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600">Today's Responses</p>
                    <p class="text-2xl font-bold text-purple-600" id="todayCount">-</p>
                </div>
                <div class="bg-purple-100 p-3 rounded-full">
                    <i class="fi fi-rr-calendar text-purple-600 text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Table -->
    <div class="bg-white p-6 rounded-lg shadow-sm border">
        <div class="overflow-x-auto">
            <table id="dataTable" class="display min-w-full">
                <thead>
                    <tr class="bg-gray-50">
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SN</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">AWB Number</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vendor</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created At</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reference No</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detailModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <!-- Modal Header -->
                <div class="flex items-center justify-between pb-4 border-b">
                    <h3 class="text-lg font-bold text-gray-900">API Response Details</h3>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fi fi-rr-cross text-xl"></i>
                    </button>
                </div>
                
                <!-- Modal Body -->
                <div class="py-4 max-h-96 overflow-y-auto">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Basic Information -->
                        <div class="space-y-4">
                            <h4 class="text-lg font-semibold text-gray-800 border-b pb-2">Basic Information</h4>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-600">AWB Number</label>
                                <p id="modal-awb-no" class="text-lg font-semibold text-blue-600"></p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-600">Vendor</label>
                                <p id="modal-vendor" class="text-gray-900 font-medium"></p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-600">Reference Number</label>
                                <p id="modal-reference-no" class="text-purple-600 font-medium"></p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-600">Status</label>
                                <div id="modal-status"></div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-600">Created At</label>
                                <p id="modal-created-at" class="text-gray-700"></p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-600">Updated At</label>
                                <p id="modal-updated-at" class="text-gray-700"></p>
                            </div>
                        </div>
                        
                        <!-- Request Information -->
                        <div class="space-y-4">
                            <h4 class="text-lg font-semibold text-gray-800 border-b pb-2">Request Information</h4>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-600">Request URL</label>
                                <p id="modal-request-url" class="text-sm text-gray-600 break-all bg-gray-50 p-2 rounded"></p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-600">Available Downloads</label>
                                <div id="modal-downloads" class="flex gap-2 mt-2"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Payload Section -->
                    <div class="mt-6">
                        <h4 class="text-lg font-semibold text-gray-800 border-b pb-2">Request Payload</h4>
                        <div class="mt-3">
                            <pre id="modal-payload" class="bg-gray-100 p-4 rounded-lg text-sm overflow-x-auto max-h-40"></pre>
                        </div>
                    </div>
                    
                    <!-- Response Section -->
                    <div class="mt-6">
                        <h4 class="text-lg font-semibold text-gray-800 border-b pb-2">API Response</h4>
                        <div class="mt-3">
                            <pre id="modal-response" class="bg-gray-100 p-4 rounded-lg text-sm overflow-x-auto max-h-40"></pre>
                        </div>
                    </div>
                </div>
                
                <!-- Modal Footer -->
                <div class="flex items-center justify-end pt-4 border-t space-x-3">
                    <button onclick="closeModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block js %}
<script>
$(document).ready(function () {
    // Initialize DataTable
    if ($.fn.DataTable.isDataTable('#dataTable')) {
        $('#dataTable').DataTable().destroy();
    }

    var table = $('#dataTable').DataTable({
        processing: true,
        serverSide: true,
        searching: true,
        paging: true,
        ordering: true,
        info: true,
        pageLength: 25,
        lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
        ajax: {
            url: "{% url 'awb:pages:awb_apiresponses:list' %}",
            type: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            data: function(d) {
                // Add custom filter parameters
                d.status_filter = $('#statusFilter').val();
                d.vendor_filter = $('#vendorFilter').val();
                d.from_date = $('#fromDate').val();
                d.to_date = $('#toDate').val();
                return d;
            },
            dataSrc: function(json) {
                // Update statistics
                updateStatistics(json);
                return json.data;
            }
        },
        columns: [
            { 
                data: function (data, type, row, meta) {
                    return meta.row + meta.settings._iDisplayStart + 1;
                },
                name: "sn", 
                searchable: false,
                orderable: false,
                className: "text-center"
            },
            { 
                data: "awb_no", 
                name: "awb_no",
                className: "font-medium text-blue-600"
            },
            { 
                data: "vendor", 
                name: "vendor",
                className: "font-medium"
            },
            { 
                data: "status", 
                name: "status",
                searchable: false,
                className: "text-center"
            },
            { 
                data: "created_at", 
                name: "created_at",
                className: "text-gray-600"
            },
            { 
                data: "reference_no", 
                name: "reference_no",
                className: "font-medium text-purple-600"
            },
            { 
                data: null,
                render: function(data, type, full, meta) {
                    let actions = `
                        <div class="flex items-center gap-2">
                            <button onclick="viewDetails(${data.id})" class="action-btn btn-primary" title="View Details">
                                <i class="fi fi-rr-eye text-sm"></i>
                                Details
                            </button>
                    `;
                    
                    
                    
                    actions += `</div>`;
                    return actions;
                },
                searchable: false,
                orderable: false,
                className: "text-center"
            }
        ],
        order: [[4, 'desc']], // Order by created_at desc
        dom: '<"flex flex-col sm:flex-row justify-between items-center mb-4"lf>rt<"flex flex-col sm:flex-row justify-between items-center mt-4"ip>',
        language: {
            search: "",
            searchPlaceholder: "Search AWB API responses...",
            lengthMenu: "Show _MENU_ entries",
            info: "Showing _START_ to _END_ of _TOTAL_ entries",
            infoEmpty: "No entries found",
            infoFiltered: "(filtered from _MAX_ total entries)",
            paginate: {
                first: "First",
                last: "Last",
                next: "Next",
                previous: "Previous"
            }
        }
    });

    // Filter functionality
    $('#statusFilter, #vendorFilter, #fromDate, #toDate').on('change', function() {
        // Reload the table with new filters
        table.ajax.reload();
    });

    // Refresh button functionality
    $('#refreshBtn').on('click', function() {
        table.ajax.reload();
    });

    // Export button functionality
    $('#exportBtn').on('click', function() {
        var exportUrl = "{% url 'awb:pages:awb_apiresponses:export' %}";
        var params = [];
        
        var statusFilter = $('#statusFilter').val();
        if (statusFilter) {
            params.push('status=' + encodeURIComponent(statusFilter));
        }
        
        var vendorFilter = $('#vendorFilter').val();
        if (vendorFilter) {
            params.push('vendor=' + encodeURIComponent(vendorFilter));
        }
        
        var fromDate = $('#fromDate').val();
        if (fromDate) {
            params.push('from_date=' + encodeURIComponent(fromDate));
        }
        
        var toDate = $('#toDate').val();
        if (toDate) {
            params.push('to_date=' + encodeURIComponent(toDate));
        }
        
        if (params.length > 0) {
            exportUrl += '?' + params.join('&');
        }
        
        window.open(exportUrl, '_blank');
    });

    // Function to update statistics
    function updateStatistics(json) {
        $('#totalCount').text(json.recordsTotal || 0);
        
        // Calculate statistics from current data
        var successCount = 0;
        var failedCount = 0;
        var failedWithRefCount = 0;
        var todayCount = 0;
        var today = new Date().toISOString().split('T')[0];
        
        if (json.data) {
            json.data.forEach(function(item) {
                if (item.status_type === 'success') {
                    successCount++;
                } else if (item.status_type === 'failure_with_ref') {
                    failedWithRefCount++;
                } else {
                    failedCount++;
                }
                
                if (item.created_at && item.created_at.startsWith(today)) {
                    todayCount++;
                }
            });
        }
        
        var currentDataLength = json.data ? json.data.length : 0;
        var total = currentDataLength || 1;
        var successRate = total > 0 ? ((successCount / total) * 100).toFixed(1) + '%' : '0%';
        
        $('#successRate').text(successRate);
        $('#failedWithRefCount').text(failedWithRefCount);
        $('#todayCount').text(todayCount);
    }

    // Store data for modal
    var tableData = {};

    // Store row data when table is drawn
    table.on('draw', function() {
        tableData = {};
        table.rows().every(function() {
            var data = this.data();
            tableData[data.id] = data;
        });
    });

    // View details function
    window.viewDetails = function(id) {
        var data = tableData[id];
        if (!data) {
            alert('Data not found. Please refresh the table.');
            return;
        }

        // Populate modal with data
        $('#modal-awb-no').text(data.awb_no);
        $('#modal-vendor').text(data.vendor);
        $('#modal-reference-no').text(data.reference_no);
        $('#modal-status').html(data.status);
        $('#modal-created-at').text(data.created_at);
        $('#modal-updated-at').text(data.updated_at);
        $('#modal-request-url').text(data.full_request_url);
        
        // Format and display payload
        try {
            var formattedPayload = data.payload ? JSON.stringify(data.payload, null, 2) : 'No payload data available';
            $('#modal-payload').text(formattedPayload);
        } catch (e) {
            $('#modal-payload').text('Invalid JSON payload');
        }
        
        // Format and display response
        try {
            var formattedResponse = data.response ? JSON.stringify(data.response, null, 2) : 'No response data available';
            $('#modal-response').text(formattedResponse);
        } catch (e) {
            $('#modal-response').text('Invalid JSON response');
        }
        
        // Handle downloads
        var downloadsHtml = '';
        if (data.has_label) {
            downloadsHtml += `
                <button onclick="downloadLabel(${data.id})" class="action-btn btn-success text-sm">
                    <i class="fi fi-rr-download text-xs"></i> Label
                </button>
            `;
        }
        if (data.has_pdf) {
            downloadsHtml += `
                <button onclick="downloadPDF(${data.id})" class="action-btn btn-info text-sm">
                    <i class="fi fi-rr-document text-xs"></i> PDF
                </button>
            `;
        }
        if (!downloadsHtml) {
            downloadsHtml = '<span class="text-gray-500 text-sm">No files available</span>';
        }
        $('#modal-downloads').html(downloadsHtml);
        
        // Show modal
        $('#detailModal').removeClass('hidden');
    };

    // Close modal function
    window.closeModal = function() {
        $('#detailModal').addClass('hidden');
    };

    // Close modal when clicking outside
    $(document).on('click', function(e) {
        if (e.target.id === 'detailModal') {
            closeModal();
        }
    });

    // Close modal with Escape key
    $(document).on('keydown', function(e) {
        if (e.key === 'Escape') {
            closeModal();
        }
    });

    // Download functions
    window.downloadLabel = function(id) {
        // Implement label download functionality
        window.open(`/awb/api-responses/${id}/download-label/`, '_blank');
    };

    window.downloadPDF = function(id) {
        // Implement PDF download functionality
        window.open(`/awb/api-responses/${id}/download-pdf/`, '_blank');
    };
});
</script>
{% endblock %}
