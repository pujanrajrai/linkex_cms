{% extends "base.html" %}
{% block title %}
  {{ title }}
{% endblock title %}
{% block pagetitle %}
  Update AWB
{% endblock pagetitle %}
{% block style %}
<style>
  .content{
    margin-top:0px !important;
  }
</style>
{% endblock style %}
{% block button %}
 
  <div class="flex gap-1">
    <a href="{% url 'awb:pages:awb:shipment_history' awb.awbno %}"
       title="History">
      <button class="bg-white text-primary border-2 border-primary hover:bg-secondary hover:text-white hover:border-secondary transition-colors duration-300 font-medium px-4 py-2 rounded flex items-center gap-1">
        <i class="fi fi-rr-time-past"></i>
      </button>
    </a>
    <a href="{% url 'awb:pages:awb:print' awb.awbno %}"
       target="_blank"
       title="Print">
      <button class="bg-white text-primary border-2 border-primary hover:bg-secondary hover:text-white hover:border-secondary transition-colors duration-300 font-medium px-4 py-2 rounded flex items-center gap-1">
        <i class="fi fi-rr-print"></i>
      </button>
    </a>
    {% if awb.vendor.code == "SGAU" or awb.vendor.code == "SGUS" or awb.vendor.code == "SGCA"   %}
    <a href="{% url 'awb:pages:awb:print_label1' awb.awbno %}" target="_blank" title="Print">
      <button class="bg-white text-primary border-2 border-primary hover:bg-secondary hover:text-white hover:border-secondary transition-colors duration-300 font-medium px-4 py-2 rounded flex items-center gap-1">
        <i class="fi fi-rr-print"></i> 1
      </button>
    </a>
    {%endif%}
    {% if awb.vendor.code == "COURIERX" %}
    <a href="{% url 'awb:pages:awb:print_courierx_label' awb.awbno %}" target="_blank" title="Print">
      <button class="bg-white text-primary border-2 border-primary hover:bg-secondary hover:text-white hover:border-secondary transition-colors duration-300 font-medium px-4 py-2 rounded flex items-center gap-1">
        <i class="fi fi-rr-print"></i> 1
      </button>
    </a>
    {%endif%}
    {% if awb.vendor.code == "UBX" %}
    <a href="{% url 'awb:pages:awb:print_ubx_label' awb.awbno %}" target="_blank" title="Print">
      <button class="bg-white text-primary border-2 border-primary hover:bg-secondary hover:text-white hover:border-secondary transition-colors duration-300 font-medium px-4 py-2 rounded flex items-center gap-1">
        <i class="fi fi-rr-print"></i> 1
      </button>
    </a>
    {%endif%}
    {% if awb.vendor.code == "DTDC" %}
    <a href="{{awb.label_1}}" target="_blank" title="Print">
      <button class="bg-white text-primary border-2 border-primary hover:bg-secondary hover:text-white hover:border-secondary transition-colors duration-300 font-medium px-4 py-2 rounded flex items-center gap-1">
        <i class="fi fi-rr-print"></i> 1
      </button>
    </a>
    {%endif%}
    <a href="{% url 'awb:pages:awb:export_awb' awb.awbno %}?format=excel"
       title="Export Invoice Excel">
      <button class="bg-white text-primary border-2 border-primary hover:bg-secondary hover:text-white hover:border-secondary transition-colors duration-300 font-medium px-4 py-2 rounded flex items-center gap-1">
        <i class="fi fi-rr-file-export"></i>
      </button>
    </a>
    <a href="{% url 'awb:pages:awb:create' %}?awb_no={{ awb.awbno }}"
       title="Clone AWB">
      <button class="bg-white text-primary border-2 border-primary hover:bg-secondary hover:text-white hover:border-secondary transition-colors duration-300 font-medium px-4 py-2 rounded flex items-center gap-1">
        <i class="fi fi-rr-clone"></i>
      </button>
    </a>
    <a href="{% url 'awb:pages:awb:create' %}" title="New AWB">
      <button class="bg-white text-primary border-2 border-primary hover:bg-secondary hover:text-white hover:border-secondary transition-colors duration-300 font-medium px-4 py-2 rounded flex items-center gap-1">
        <i class="fi fi-rr-add"></i>
      </button>
    </a>
    <button id="close_current_tab"
            class="bg-red-500 text-primary border-2 border-primary hover:bg-secondary hover:text-white hover:border-secondary transition-colors duration-300 font-medium px-4 py-2 rounded flex items-center gap-1"
            title="Close Tab">
      <i class="fi fi-rr-cross"></i>
    </button>
  </div>
{% endblock %}
{% block content %}
<style>
  #box_item_list tr:visible:not(:last-child) .add-box-item {
    display: none;
  }
  #box_detail tr:not(:last-child) .add-box-detail {
    display: none;
  }
  #box_item_list tr:only-of-type .remove-box-item {
    display: none;
  }
  #box_detail tr:only-of-type .remove-box-detail {
    display: none;
  }
</style>
  {% if box_details_formset.non_form_errors %}
    <div class="p-4 mb-4 bg-red-100 text-red-700 rounded-md">
      <h3 class="font-bold">Form Errors:</h3>
      <ul>
        {% for error in box_details_formset.non_form_errors %}<li>{{ error }}</li>{% endfor %}
      </ul>
    </div>
  {% endif %}
  <div>
    {% include "awb/awb/tab.html" %}
    
    <form method="post"
          enctype="multipart/form-data"
          autocomplete="off"
          id="awb_create_form">
      {% csrf_token %}
      {{ box_details_formset.management_form }}
      {{ box_item_formset.management_form }}
      <input type="hidden" name="awb-agency" value="{{ awb_form.initial.agency }}">

      <div class="p-4 bg-gray-50 rounded-md shadow-md">
        
        <div class="grid grid-cols-12 gap-1">
         <!-- AWB Number -->
         <div class="col-span-2">
           <div id="awb_no_container" class="flex flex-col">
            
            <div id="is_custom_field" class="flex flex-row items-center gap-1">
              {{ awb_form.awbno.label_tag }}
              <label for="{{ awb_form.is_custom.id_for_label }}"
                     class="text-sm text-gray-600">Custom?</label>
              {{ awb_form.is_custom }}
            </div>
             
             <div class="awb-field">
              {{ awb_form.awbno }} 
              

             </div>
             {% if awb_form.awbno.errors %}<p class="text-red-500 text-xs italic">{{ awb_form.awbno.errors }}</p>{% endif %}
             {% if awb_form.awbno.help_text %}<p class="text-gray-600 text-xs">{{ awb_form.awbno.help_text }}</p>{% endif %}
           </div>
         </div>

         <!-- Agency -->
        <div class="col-span-3">
          <div class="flex flex-col" id="agency_field_container">
            
            <div class="flex flex-row items-center gap-1">
              {{ awb_form.agency.label_tag }}
              
              {% if request.user.role == 'admin' %}
              <label for="{{ awb_form.is_cash_user.id_for_label }}" class="text-sm text-gray-600">
                CASH?
              </label>
              {{ awb_form.is_cash_user }}
              {% endif %}
            </div>

            <div class="awb-field">
              {{ awb_form.agency }}
            </div>

            {% if awb_form.agency.errors %}
            <p class="text-red-500 text-xs italic">{{ awb_form.agency.errors }}</p>
            {% endif %}

            {% if awb_form.agency.help_text %}
            <p class="text-gray-600 text-xs">{{ awb_form.agency.help_text }}</p>
            {% endif %}
          </div>
        </div>

         <!-- Company -->
         <div class="col-span-2">
           {{ awb_form.company.label_tag }}
           <div class="awb-field">{{ awb_form.company }}</div>
           {% if awb_form.company.errors %}<p class="text-red-500 text-xs italic">{{ awb_form.company.errors }}</p>{% endif %}
           {% if awb_form.company.help_text %}<p class="text-gray-600 text-xs">{{ awb_form.company.help_text }}</p>{% endif %}
         </div>

         <!-- Hub -->
         <div class="col-span-2">
           {{ awb_form.hub.label_tag }}
           <div class="awb-field">{{ awb_form.hub }}</div>
           {% if awb_form.hub.errors %}<p class="text-red-500 text-xs italic">{{ awb_form.hub.errors }}</p>{% endif %}
           {% if awb_form.hub.help_text %}<p class="text-gray-600 text-xs">{{ awb_form.hub.help_text }}</p>{% endif %}
         </div>

         <!-- Vendor -->
         <div class="col-span-3">
           {{ awb_form.vendor.label_tag }}
           <div class="awb-field">{{ awb_form.vendor }}</div>
           {% if awb_form.vendor.errors %}<p class="text-red-500 text-xs italic">{{ awb_form.vendor.errors }}</p>{% endif %}
           {% if awb_form.vendor.help_text %}<p class="text-gray-600 text-xs">{{ awb_form.vendor.help_text }}</p>{% endif %}
         </div>

         <!-- Product Type -->
         <div class="col-span-2">
           {{ awb_form.product_type.label_tag }}
           <div class="awb-field">{{ awb_form.product_type }}</div>
           {% if awb_form.product_type.errors %}<p class="text-red-500 text-xs italic">{{ awb_form.product_type.errors }}</p>{% endif %}
           {% if awb_form.product_type.help_text %}<p class="text-gray-600 text-xs">{{ awb_form.product_type.help_text }}</p>{% endif %}
         </div>

         <!-- Service -->
         <div class="col-span-2">
           {{ awb_form.service.label_tag }}
           <div class="awb-field">{{ awb_form.service }}</div>
           {% if awb_form.service.errors %}<p class="text-red-500 text-xs italic">{{ awb_form.service.errors }}</p>{% endif %}
           {% if awb_form.service.help_text %}<p class="text-gray-600 text-xs">{{ awb_form.service.help_text }}</p>{% endif %}
         </div>
         <!-- Shipment Value -->  
         <div class="col-span-2"> 
           {{ awb_form.shipment_value.label_tag }}
           <div class="awb-field">{{ awb_form.shipment_value }}</div>
           {% if awb_form.shipment_value.errors %}<p class="text-red-500 text-xs italic">{{ awb_form.shipment_value.errors }}</p>{% endif %}
           {% if awb_form.shipment_value.help_text %}<p class="text-gray-600 text-xs">{{ awb_form.shipment_value.help_text }}</p>{% endif %}
         </div>
         <!-- Currency -->
         <div class="col-span-2">
           {{ awb_form.currency.label_tag }}
           <div class="awb-field">{{ awb_form.currency }}</div>
           {% if awb_form.currency.errors %}<p class="text-red-500 text-xs italic">{{ awb_form.currency.errors }}</p>{% endif %}
           {% if awb_form.currency.help_text %}<p class="text-gray-600 text-xs">{{ awb_form.currency.help_text }}</p>{% endif %}
         </div>
       
         

         <!-- Forwarding Number -->
         <div class="col-span-2">
           <div class="flex flex-col">
             <div class="flex items-center justify-between">
               {{ awb_form.forwarding_number.label_tag }}
               {% comment %} <div class="flex items-center gap-1">
                 <label for="import_box_awb" class="text-sm text-gray-600">Import Box AWB No:</label>
                 <input type="checkbox"
                        id="import_box_awb" checked
                        class="form-checkbox h-5 w-5 text-gray-600 rounded border-gray-300 focus:ring-gray-500">
               </div> {% endcomment %}
             </div>
             <div class="awb-field">{{ awb_form.forwarding_number }}</div>
             <div id="box_awb_results" class="mt-2 text-sm"></div>
             {% if awb_form.forwarding_number.errors %}<p class="text-red-500 text-xs italic">{{ awb_form.forwarding_number.errors }}</p>{% endif %}
             {% if awb_form.forwarding_number.help_text %}<p class="text-gray-600 text-xs">{{ awb_form.forwarding_number.help_text }}</p>{% endif %}
           </div>
         </div>

         <!-- Reference Number -->
         <div class="col-span-2">
           <div class="flex flex-col">
             <div class="flex items-center justify-between">
               {{ awb_form.reference_number.label_tag }}
               <div class="flex items-center gap-1">
                 
               </div>
             </div>
             <div class="awb-field">{{ awb_form.reference_number }}</div>
             {% if awb_form.reference_number.errors %}<p class="text-red-500 text-xs italic">{{ awb_form.reference_number.errors }}</p>{% endif %}
             {% if awb_form.reference_number.help_text %}<p class="text-gray-600 text-xs">{{ awb_form.reference_number.help_text }}</p>{% endif %}
           </div>
         </div>
         <!-- Reason for Export -->
         <div class="col-span-2">
           {{ awb_form.reason_for_export.label_tag }}
           <div class="awb-field">{{ awb_form.reason_for_export }}</div>
           {% if awb_form.reason_for_export.errors %}<p class="text-red-500 text-xs italic">{{ awb_form.reason_for_export.errors }}</p>{% endif %}
           {% if awb_form.reason_for_export.help_text %}<p class="text-gray-600 text-xs">{{ awb_form.reason_for_export.help_text }}</p>{% endif %}
         </div> 
         <!-- Incoterms -->
         <div class="col-span-2">
           {{ awb_form.incoterms.label_tag }}
           <div class="awb-field">{{ awb_form.incoterms }}</div>
           {% if awb_form.incoterms.errors %}<p class="text-red-500 text-xs italic">{{ awb_form.incoterms.errors }}</p>{% endif %}
           {% if awb_form.incoterms.help_text %}<p class="text-gray-600 text-xs">{{ awb_form.incoterms.help_text }}</p>{% endif %}
         </div> 
         <!-- Shipment Terms -->
         <div class="col-span-2">
           {{ awb_form.shipment_terms.label_tag }}
           <div class="awb-field">{{ awb_form.shipment_terms }}</div>
           {% if awb_form.shipment_terms.errors %}<p class="text-red-500 text-xs italic">{{ awb_form.shipment_terms.errors }}</p>{% endif %}
           {% if awb_form.shipment_terms.help_text %}<p class="text-gray-600 text-xs">{{ awb_form.shipment_terms.help_text }}</p>{% endif %}
         </div> 
          <!-- Content -->
        <div class="col-span-6">
          <div class="flex flex-col">
            <div class="flex items-center justify-between">
              {{ awb_form.content.label_tag }}
              <div class="flex items-center gap-1">
                <label for="import_box_items" class="text-sm text-gray-600">Import from Box Items:</label>
                <input type="checkbox"
                       id="import_box_items"
                       class="form-checkbox h-5 w-5 text-gray-600 rounded border-gray-300 focus:ring-gray-500">
              </div>
            </div>
            <div class="awb-field">{{ awb_form.content }}</div>
            {% if awb_form.content.errors %}<p class="text-red-500 text-xs italic">{{ awb_form.content.errors }}</p>{% endif %}
            {% if awb_form.content.help_text %}<p class="text-gray-600 text-xs">{{ awb_form.content.help_text }}</p>{% endif %}
          </div>
        </div>

         
       </div>
    </div>

    <!-- Consignor and Consignee in a 2-column grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-1 mt-2">
      <div class="p-4 bg-gray-50 rounded-md shadow-md">
        <div class="flex justify-between items-center">
          <h2 class="text-lg font-semibold mb-1">Consignor Details</h2>
          <div class="flex flex-row gap-1">
            <label for="clear_consignor_details">Clear Data:</label>
            <input type="checkbox"
                   id="clear_consignor_details"
                   name="clear_consignor_details">
          </div>
        </div>
        <div class="grid grid-cols-12 gap-1">
          {% for field in consignor_form %}
            {% if field.name == "post_zip_code" %}
              <div class="col-span-6">
                {{ awb_form.origin.label_tag }}
                {{ awb_form.origin }}
                {% if awb_form.origin.errors %}<p class="text-red-500 text-xs italic">{{ awb_form.origin.errors }}</p>{% endif %}
                {% if awb_form.origin.help_text %}<p class="text-gray-600 text-xs">{{ awb_form.origin.help_text }}</p>{% endif %}
              </div>
              <div class="col-span-6">
                {{ field.label_tag }}
                <div class="">
                  <div class="">
                    <div class="consignor-field">{{ field }}</div>
                  </div>
                  <div class="results" id="consignor_results"></div>
                </div>
                {% if field.errors %}<p class="text-red-500 text-xs italic">{{ field.errors }}</p>{% endif %}
              </div>
            {% else %}
              <div class="{% if field.name in 'city state_county country document_type document_number document_front document_back phone_number state_abbreviation   email_address ' %}col-span-6{% else %}col-span-6{% endif %}">
                {{ field.label_tag }}
                {{ field }}
                {% if field.errors %}<p class="text-red-500 text-xs italic">{{ field.errors }}</p>{% endif %}
                {% if field.help_text %}<p class="text-gray-600 text-xs">{{ field.help_text }}</p>{% endif %}
              </div>
            {% endif %}
            {% if forloop.last %}
              <!-- Consignor Address Search Field -->
              <div class="col-span-12 mt-4">
                <div class="relative w-full">
                  <input type="text"
                         id="consignor_google_search"
                         class="address-search-field w-full pr-10 px-3 py-3 focus:border-gray-500 focus:outline-none focus:ring-1 focus:ring-gray-500 rounded-md placeholder-transparent"
                         data-search-type="consignor"
                         style="font-size: 10px"
                         readonly>
                  <button type="button"
                          class="google-search-button absolute inset-y-0 right-0 px-3 py-3 flex items-center"
                          data-search-id="consignor_google_search"
                          title="Search on Google">
                    <svg xmlns="http://www.w3.org/2000/svg"
                         class="h-4 w-4 text-gray-500 hover:text-gray-700"
                         fill="none"
                         viewBox="0 0 24 24"
                         stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                  </button>
                </div>
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </div>
      <div class="p-4 bg-gray-50 rounded-md shadow-md">
        
        <h2 class="text-lg font-semibold mb-1 flex justify-between">
          Consignee Details
          {% if request.user.role == "admin" and awb.runawb_set.all %}
            <div class="space-y-1 mt-1">
              {% for run_awb in awb.runawb_set.all %}
                <div class="flex text-sm">
                  <span>Run No: {{ run_awb.run.run_no|default:"-" }}</span> &nbsp; / &nbsp;
                  <span>MAWB No: {{ run_awb.run.mawb_no|default:"-" }}</span> &nbsp; / &nbsp;
                </div>
              {% endfor %}
            </div>
          {% endif %}
        </h2>
        <div class="grid grid-cols-12 gap-1">
          {% for field in consignee_form %}
            {% if field.name == "post_zip_code" %}
              <div class="col-span-6">
                {{ awb_form.destination.label_tag }}
                {{ awb_form.destination }}
                {% if awb_form.destination.errors %}
                  <p class="text-red-500 text-xs italic">{{ awb_form.destination.errors }}</p>
                {% endif %}
                {% if awb_form.destination.help_text %}
                  <p class="text-gray-600 text-xs">{{ awb_form.destination.help_text }}</p>
                {% endif %}
              </div>
              <div class="col-span-6">
                {{ field.label_tag }}
                <div class="">
                  <div class="">
                    <div class="consignee-field">{{ field }}</div>
                  </div>
                  <div class="results" id="consignee_results"></div>
                </div>
                {% if field.errors %}<p class="text-red-500 text-xs italic">{{ field.errors }}</p>{% endif %}
              </div>
              {% elif field.name == "phone_number" or field.name == "phone_number_2" %}
                <div class="col-span-2">
                  {% if field.name == "phone_number" %}
                    <label for="id_country_code_1" class="text-xs text-gray-600">Code</label>
                    <input type="text" id="id_country_code_1" class="text-sm peer block pt-1 pb-1 w-full appearance-none border border-gray-300 bg-white py-3 px-3 text-gray-800 focus:border-gray-500 focus:outline-none focus:ring-1 focus:ring-gray-500 rounded-md placeholder-transparent" readonly tabindex="-1">
                  {% elif field.name == "phone_number_2" %}
                    <label for="id_country_code_2" class="text-xs text-gray-600">Code</label>
                    <input type="text" id="id_country_code_2" class="text-sm peer block pt-1 pb-1 w-full appearance-none border border-gray-300 bg-white py-3 px-3 text-gray-800 focus:border-gray-500 focus:outline-none focus:ring-1 focus:ring-gray-500 rounded-md placeholder-transparent" readonly tabindex="-1">
                  {% endif %}
                </div>
                <div class="col-span-4">
                  {{ field.label_tag }}
                  {{ field }}
                  {% if field.errors %}<p class="text-red-500 text-xs italic">{{ field.errors }}</p>{% endif %}
                  {% if field.help_text %}<p class="text-gray-600 text-xs">{{ field.help_text }}</p>{% endif %}
                </div>
            {% else %}
              <div class='{% if field.name in "city state_county country document_type document_number document_front document_back phone_number email_address state_abbreviation   " %}col-span-6{% else %}col-span-6{% endif %}'>
                {{ field.label_tag }}
                {{ field }}
                {% if field.errors %}<p class="text-red-500 text-xs italic">{{ field.errors }}</p>{% endif %}
                {% if field.help_text %}<p class="text-gray-600 text-xs">{{ field.help_text }}</p>{% endif %}
              </div>
            {% endif %}
            {% if forloop.last %}
              <!-- Consignee Address Search Field -->
              <div class="col-span-12 mt-4">
                <div class="relative w-full">
                  <input type="text"
                         id="consignee_google_search"
                         class="address-search-field w-full pr-10 px-3 py-3 focus:border-gray-500 focus:outline-none focus:ring-1 focus:ring-gray-500 rounded-md placeholder-transparent"
                         data-search-type="consignee"
                         style="font-size: 10px"
                         readonly>
                  <button type="button"
                          class="google-search-button absolute inset-y-0 right-0 px-3 py-3 flex items-center"
                          data-search-id="consignee_google_search"
                          title="Search on Google">
                    <svg xmlns="http://www.w3.org/2000/svg"
                         class="h-4 w-4 text-gray-500 hover:text-gray-700"
                         fill="none"
                         viewBox="0 0 24 24"
                         stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                  </button>
                </div>
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </div>
    </div>
      <div class="p-4 mt-3 bg-gray-50 rounded-md shadow-md">
        <div class="grid grid-cols-2 items-center mb-4">
          <div class="flex">
            <div>
              <h1 class="text-xl font-semibold">Box Detail</h1>
            </div>
            <div class="flex ml-5">
              <input type="checkbox"
                     id="toggle_box_item"
                     name="create_shipment_invoice"
                     {% if create_shipment_invoice %}checked{% endif %}>
              <label class="mt-1.5 ml-2">Create Shipment Invoice:</label>
            </div>
          </div>
          <div class="grid grid-flow-col gap-1">
            <div class="grid grid-flow-col gap-1">
              <div class="text-xs">
                <label for="total_box_count">Total Box Count:</label>
                <input type="number"
                       name="total_box_count"
                       class="peer block w-full appearance-none border border-gray-300 bg-white px-3 pt-1 pb-1 text-gray-800 rounded-md"
                       min="1"
                       id="total_box_count"
                       value="{{ total_box_count }}"
                       required>
              </div>
              <div class="text-xs">
                {{ awb_form.dividing_factor.label_tag }}
                {{ awb_form.dividing_factor }}
                {% if awb_form.dividing_factor.errors %}
                  <p class="text-red-500 text-xs italic">{{ awb_form.dividing_factor.errors }}</p>
                {% endif %}
                {% comment %} <label for="box_total_dividing_factor">Dividing Factor:</label>
                <select name="box_total_dividing_factor" id="box_total_dividing_factor" class="peer block w-full appearance-none border border-gray-300 bg-white px-3 pt-3 pb-2 text-gray-800 rounded-md" required>
                  {% for factor in dividing_factor %}<option value="{{ factor.factor }}">{{ factor.factor }}</option>{% endfor %}
                </select> {% endcomment %}
              </div>
            </div>
          </div>
        </div>
        <div>
          <table id="box-details-table"
                 class="table-auto border-collapse border border-gray-300 w-full text-sm">
            <thead class="bg-gray-200 text-left">
              <tr>
                <th class="border border-gray-300 px-2 py-1">Box AWB Number</th>
                <th class="border border-gray-300 px-2 py-1">Box Number</th>
                <th class="border border-gray-300 px-2 py-1">Length</th>
                <th class="border border-gray-300 px-2 py-1">Breadth</th>
                <th class="border border-gray-300 px-2 py-1">Height</th>
                <th class="border border-gray-300 px-2 py-1">Actual Weight</th>
                <th class="border border-gray-300 px-2 py-1">Volumetric Weight</th>
                <th class="border border-gray-300 px-2 py-1">Charged Weight</th>
                {% comment %} <th class="border border-gray-300 px-2 py-1">Action</th> {% endcomment %}
              </tr>
            </thead>
            <tfoot class="bg-gray-200 text-left">
              <tr>
                <th class="border border-gray-300 px-2 py-1"></th>
                <th class="border border-gray-300 px-2 py-1"></th>
                <th class="border border-gray-300 px-2 py-1"></th>
                <th class="border border-gray-300 px-2 py-1"></th>
                <th class="border border-gray-300 px-2 py-1"></th>
                <th class="border border-gray-300 px-2 py-1">Total A.WT: 0.00</th>
                <th class="border border-gray-300 px-2 py-1">Total V. WGT: 0.00</th>
                <th class="border border-gray-300 px-2 py-1">Total C.WT: 0.00</th>
                {% comment %} <th class="border border-gray-300 px-2 py-1"></th> {% endcomment %}
              </tr>
            </tfoot>
            <tbody id="box_detail">
              {% for form in box_details_formset %}
                {% for hidden in form.hidden_fields %}
                  {{ hidden }}
                {% endfor %}
                <tr data-index="{{ forloop.counter0 }}"
                    class="{% if form.errors %}bg-red-50{% else %}border-t{% endif %}">
                  <td class="border border-gray-300 px-2 py-1">
                    {{ form.box_awb_no }}
                    {% if form.box_awb_no.errors %}<div class="text-red-500 text-xs italic">{{ form.box_awb_no.errors }}</div>{% endif %}
                  </td>
                  <td class="border border-gray-300 px-2 py-1">
                    {{ form.box_number }}
                    {% if form.box_number.errors %}<div class="text-red-500 text-xs italic">{{ form.box_number.errors }}</div>{% endif %}
                  </td>
                  <td class="border border-gray-300 px-2 py-1">
                    {{ form.length }}
                    {% if form.length.errors %}<div class="text-red-500 text-xs italic">{{ form.length.errors }}</div>{% endif %}
                  </td>
                  <td class="border border-gray-300 px-2 py-1">
                    {{ form.breadth }}
                    {% if form.breadth.errors %}<div class="text-red-500 text-xs italic">{{ form.breadth.errors }}</div>{% endif %}
                  </td>
                  <td class="border border-gray-300 px-2 py-1">
                    {{ form.height }}
                    {% if form.height.errors %}<div class="text-red-500 text-xs italic">{{ form.height.errors }}</div>{% endif %}
                  </td>
                  <td class="border border-gray-300 px-2 py-1">
                    {{ form.actual_weight }}
                    {% if form.actual_weight.errors %}
                      <div class="text-red-500 text-xs italic">{{ form.actual_weight.errors }}</div>
                    {% endif %}
                  </td>
                  <td class="border border-gray-300 px-2 py-1">
                    {{ form.volumetric_weight }}
                    {% if form.volumetric_weight.errors %}
                      <div class="text-red-500 text-xs italic">{{ form.volumetric_weight.errors }}</div>
                    {% endif %}
                  </td>
                  <td class="border border-gray-300 px-2 py-1">
                    {{ form.charged_weight }}
                    {% if form.charged_weight.errors %}
                      <div class="text-red-500 text-xs italic">{{ form.charged_weight.errors }}</div>
                    {% endif %}
                  </td>
                  
                  </td>
                </tr>
                {% if form.non_field_errors %}
                  <tr class="bg-red-50">
                    <td colspan="7" class="border border-gray-300 px-2 py-1">
                      <div class="text-red-500 text-xs italic">
                        {% for error in form.non_field_errors %}<p>{{ error }}</p>{% endfor %}
                      </div>
                    </td>
                  </tr>
                {% endif %}
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="p-4 mt-3 bg-gray-50 rounded-md shadow-md" id="box_item">
        <h1 class="text-xl font-semibold mb-4">Box Items</h1>
        <div>
          <table class="table-auto border-collapse border border-gray-300 w-full text-sm">
            <thead class="bg-gray-200 text-left">
              <tr>
                <th class="border border-gray-300 px-2 py-1 w-[7%]">Box Number</th>
                <th class="border border-gray-300 px-2 py-1 w-[25%]">Description</th>
                <th class="border border-gray-300 px-2 py-1 w-[7%]">HS Code</th>
                <th class="border border-gray-300 px-2 py-1 w-[7%]">Unit Type</th>
                <th class="border border-gray-300 px-2 py-1 w-[7%]">Quantity</th>
                <th class="border border-gray-300 px-2 py-1 w-[7%]">Unit Weight</th>
                <th class="border border-gray-300 px-2 py-1 w-[7%]">Unit Rate</th>
                <th class="border border-gray-300 px-2 py-1 w-[7%]">Amount</th>
                <th class="border border-gray-300 px-2 py-1 w-[7%]">Action</th>
              </tr>
            </thead>
            <tfoot class="bg-gray-200 text-left">
              <tr>
                <th class="border border-gray-300 px-2 py-1"></th>
                <th class="border border-gray-300 px-2 py-1"></th>
                <th class="border border-gray-300 px-2 py-1"></th>
                <th class="border border-gray-300 px-2 py-1"></th>
                <th id="totalQuantityCell"
                    class="border border-gray-300 px-2 py-1 text-right text-sm">Total Quantity: 0.00</th>
                <th id="totalUnitWeightCell"
                    class="border border-gray-300 px-2 py-1 text-right text-sm">Total U.WT: 0.00</th>
                <th id="totalUnitRateCell"
                    class="border border-gray-300 px-2 py-1 text-right text-sm"></th>
                <th id="totalAmountCell"
                    class="border border-gray-300 px-2 py-1"
                    colspan="2">Total Amount: 0.00</th>
              </tr>
            </tfoot>
            <tbody id="box_item_list">
              {% for form in box_item_formset %}
                {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}
                <tr data-index="{{ forloop.counter0 }}"
                    class="{% if form.errors %}bg-red-50{% else %}border-t{% endif %}"
                    name="box_item-{{ forloop.counter0 }}">
                  <td class="border border-gray-300 px-2 py-1">
                    {{ form.box_number }}
                    {% if form.box_number.errors %}<div class="text-red-500 text-xs italic">{{ form.box_number.errors }}</div>{% endif %}
                  </td>
                  <td class="border border-gray-300 px-2 py-1">
                    {{ form.description }}
                    {% if form.description.errors %}
                      <div class="text-red-500 text-xs italic">{{ form.description.errors }}</div>
                    {% endif %}
                  </td>
                  <td class="border border-gray-300 px-2 py-1">
                    {{ form.hs_code }}
                    {% if form.hs_code.errors %}<div class="text-red-500 text-xs italic">{{ form.hs_code.errors }}</div>{% endif %}
                  </td>
                  <td class="border border-gray-300 px-2 py-1">
                    {{ form.unit_type }}
                    {% if form.unit_type.errors %}<div class="text-red-500 text-xs italic">{{ form.unit_type.errors }}</div>{% endif %}
                  </td>
                  <td class="border border-gray-300 px-2 py-1">
                    {{ form.quantity }}
                    {% if form.quantity.errors %}<div class="text-red-500 text-xs italic">{{ form.quantity.errors }}</div>{% endif %}
                  </td>
                  <td class="border border-gray-300 px-2 py-1">
                    {{ form.unit_weight }}
                    {% if form.unit_weight.errors %}
                      <div class="text-red-500 text-xs italic">{{ form.unit_weight.errors }}</div>
                    {% endif %}
                  </td>
                  <td class="border border-gray-300 px-2 py-1">
                    {{ form.unit_rate }}
                    {% if form.unit_rate.errors %}<div class="text-red-500 text-xs italic">{{ form.unit_rate.errors }}</div>{% endif %}
                  </td>
                  <td class="border border-gray-300 px-2 py-1">
                    {{ form.amount }}
                    {% if form.amount.errors %}<div class="text-red-500 text-xs italic">{{ form.amount.errors }}</div>{% endif %}
                  </td>
                  <td class="border border-gray-300 px-2 py-1 flex gap-1">
                    <button type="button"
                            tabindex="-1"
                            title="Add Box Item"
                            id="add-box-item"
                            class="add-box-item bg-green-500 text-white px-3 py-1 rounded-md hover:bg-green-600 text-sm">
                            <i class="fi fi-rr-plus"></i>
                    </button>
                    <button type="button"
                            tabindex="-1"
                            class="remove-box-item bg-red-500 text-white px-3 py-1 rounded-md hover:bg-red-600 text-sm">
                      Remove
                    </button>
                  </td>
                </tr>
                {% if form.non_field_errors %}
                  <tr class="bg-red-50">
                    <td colspan="9" class="border border-gray-300 px-2 py-1">
                      <div class="text-red-500 text-xs italic">
                        {% for error in form.non_field_errors %}<p>{{ error }}</p>{% endfor %}
                      </div>
                    </td>
                  </tr>
                {% endif %}
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 px-4 py-2 z-50 shadow-lg">
        <div class="max-w-7xl mx-auto">
          <div class="flex gap-2">
            {% if awb.vendor.code == "DTDC" or awb.vendor.code == "SGAU" or awb.vendor.code == "SGUS" or awb.vendor.code == "SGCA" or awb.vendor.code == "COURIERX" or awb.vendor.code == "UBX" %}
            {% if not awb.is_api_called_success%}
            <button type="button" id="call-vendor-api"
                 class="flex-1 bg-primary text-white border-2 border-primary hover:bg-primary-dark transition-colors duration-200 font-medium px-4 py-2 rounded-lg shadow-sm flex items-center justify-center gap-2 text-sm"
                 data-awb-no="{{ awb.awbno }}"
                 data-vendor-code="{{ awb.vendor.code }}">
                <i class="fi fi-rr-check"></i>
                <span>Call API</span>
              </button>
            {% else%}
            <a href="#"
            class="flex-1 bg-primary text-white border-2 border-primary hover:bg-primary-dark transition-colors duration-200 font-medium px-4 py-2 rounded-lg shadow-sm flex items-center justify-center gap-2 text-sm">
           <i class="fi fi-rr-check"></i>
           <span>API Called Successfully</span>
            </a>
            {% endif %}
            {% endif %}            
            <a href="{% url 'awb:pages:awb:detail' awb.awbno %}"
               class="flex-1 bg-white text-primary border-2 border-primary hover:bg-primary hover:text-white transition-colors duration-200 font-medium px-4 py-2 rounded-lg shadow-sm flex items-center justify-center gap-2 text-sm">
              <i class="fi fi-rr-eye"></i>
              <span>Details</span>
            </a>
            {% if not awb.is_verified and not awb.is_in_run %}
              <a href="{% url 'awb:pages:awb:verify' awb.awbno %}"
                 class="flex-1 bg-primary text-white border-2 border-primary hover:bg-primary-dark transition-colors duration-200 font-medium px-4 py-2 rounded-lg shadow-sm flex items-center justify-center gap-2 text-sm">
                <i class="fi fi-rr-check"></i>
                <span>Verify AWB</span>
              </a>
            {% elif not awb.is_in_run %}
              <a href="{% url 'awb:pages:awb:unverify' awb.awbno %}"
                 class="flex-1 bg-red-500 text-white border-2 border-red-500 hover:bg-red-600 transition-colors duration-200 font-medium px-4 py-2 rounded-lg shadow-sm flex items-center justify-center gap-2 text-sm">
                <i class="fi fi-rr-cross"></i>
                <span>Unverify AWB</span>
              </a>
            {% endif %}
            {% if awb.is_editable%}
            <button type="submit"
                    class="flex-1 bg-primary text-white border-2 border-primary hover:bg-primary-dark transition-colors duration-200 font-medium px-4 py-2 rounded-lg shadow-sm flex items-center justify-center gap-2 text-sm">
              <i class="fi fi-rr-disk"></i>
              <span>Update AWB</span>
            </button>
            {%endif%}
          </div>
        </div>
      </div>
      <div class="h-16"></div> <!-- Reduced spacer height to match smaller buttons -->
      <div class="h-16"></div> <!-- Reduced spacer height to match smaller buttons -->
    </form>
    <div class="mt-6 text-center">
      <a href="#" class="text-gray-600 hover:underline font-semibold text-lg">‚Üê Back to AWB List</a>
    </div>
  </div>
  <div class="mt-6 text-center">
    
  </div>

  <!-- Floating Action Buttons -->
  <div class="fixed right-1 top-2/3 transform -translate-y-1/3 z-40 space-y-1">
    <!-- Airplane Button -->
    <div class="group relative">
      <button type="button" 
              class="track-btn w-10 h-8 bg-blue-500 hover:bg-blue-600 text-white rounded-md shadow-md hover:shadow-lg transition-all duration-200 flex items-center justify-center group-hover:scale-105"
              data-awbno="{{ awb.awbno }}"
              title="Track Shipment">
        <i class="fi fi-rr-plane text-sm"></i>
      </button>
      <!-- Tooltip -->
      <div class="absolute right-12 top-1/2 transform -translate-y-1/2 bg-gray-800 text-white px-2 py-1 rounded text-xs opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap">
        Track
        <div class="absolute top-1/2 -right-1 transform -translate-y-1/2 w-1 h-1 bg-gray-800 rotate-45"></div>
      </div>
    </div>

    <!-- Bill Button -->
    <div class="group relative">
      <button type="button" 
              class="w-10 h-8 bg-green-500 hover:bg-green-600 text-white rounded-md shadow-md hover:shadow-lg transition-all duration-200 flex items-center justify-center group-hover:scale-105"
              title="Billing & Invoice">
        <i class="fi fi-rr-receipt text-sm"></i>
      </button>
      <!-- Tooltip -->
      <div class="absolute right-12 top-1/2 transform -translate-y-1/2 bg-gray-800 text-white px-2 py-1 rounded text-xs opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap">
        Bill
        <div class="absolute top-1/2 -right-1 transform -translate-y-1/2 w-1 h-1 bg-gray-800 rotate-45"></div>
      </div>
    </div>
  </div>

  <!-- Include Tracking Modal -->
  {% include "awb/awb/js/tracking-modal.html" %}

  <!-- API Response Modal -->
  <div id="api-response-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-2/3 lg:w-1/2 shadow-lg rounded-md bg-white">
      <div class="mt-3">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-bold text-gray-900" id="modal-title">API Response</h3>
          <button type="button" class="text-gray-400 hover:text-gray-600" id="close-modal">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        
        <div id="modal-content">
          <!-- Content will be populated by JavaScript -->
        </div>
        
        <div class="flex justify-end mt-6">
          <button type="button" id="modal-close-btn" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 mr-2">
            Close
          </button>
          <button type="button" id="reload-page-btn" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-dark hidden">
            Reload Page
          </button>
        </div>
      </div>
    </div>
  </div>

{% endblock content %}
{% block js %}
  {% comment %} {% include "awb/awb/js/agency_detail.html" %} {% endcomment %}
  {% include "awb/awb/js/awb_update.html" %}
  {% include "awb/awb/js/update_calculate_box_detail.html" %}
  {% include "awb/awb/js/mainjs.html" %}
  {% include "awb/awb/js/tab_index.html" %}
  {% include "awb/awb/js/zipcode.html" %}
  {% include "awb/awb/js/hs-code.html" %}
  {% include "awb/awb/js/remove_box_item.html" %}
  {% include "awb/awb/js/google_search.html" %}
  {% comment %} {% include "awb/awb/js/update_vendor_with_hub.html" %} {% endcomment %}
  {% include "awb/awb/js/update_service_and_prd_type_with_vendor.html" %}
  {% include "awb/awb/js/add_box_item.html" %}
  <script>
    $(document).ready(function() {
      function updateManagementForm() {
        const totalBoxes = parseInt($('#total_box_count').val(), 10) || 1;
        $('#id_box_details-TOTAL_FORMS').val(totalBoxes);
        $('#id_box_details-INITIAL_FORMS').val('0');
        $('#id_box_details-MIN_NUM_FORMS').val('1');
        $('#id_box_details-MAX_NUM_FORMS').val('1000');
        console.log('Updated box details management form:', $('#id_box_details-TOTAL_FORMS').val());
      }

      function updateBoxNumberOptions() {
        const totalBoxes = parseInt($('#total_box_count').val(), 10) || 1;
        $('.box-number-select').empty();
        for (let i = 1; i <= totalBoxes; i++) {
          $('.box-number-select').append(
            $('<option>', {
              value: `Box-${i}`,
              text: `Box-${i}`
            })
          );
        }
      }

      function updateBoxItemsManagementForm() {
        const visibleRows = $('#box_item_list tr').length;
        $('#id_box_item-TOTAL_FORMS').val(visibleRows);
        $('#id_box_item-INITIAL_FORMS').val('0');
        $('#id_box_item-MIN_NUM_FORMS').val('0');
        $('#id_box_item-MAX_NUM_FORMS').val('1000');
        console.log('Updated box items management form:', $('#id_box_item-TOTAL_FORMS').val());
      }

      updateManagementForm();
      updateBoxNumberOptions();
      updateBoxItemsManagementForm();
      
      $('#total_box_count').on('change', function() {
        updateManagementForm();
        updateBoxNumberOptions();
        if (window.boxItemFunctions && window.boxItemFunctions.updateBoxItemDropdowns) {
          const boxCount = parseInt($(this).val(), 10) || 1;
          window.boxItemFunctions.updateBoxItemDropdowns(boxCount);
        }
      });
      $(document).ready(function() {
        // Function to import box AWB numbers
        function importBoxAWBNumbers() {
          const boxAwbNumbers = [];
          $('#box_detail tr').each(function() {
            const boxAwbNo = $(this).find('input[name$="-box_awb_no"]').val();
            if (boxAwbNo) {
              boxAwbNumbers.push(boxAwbNo);
            }
          });
      
          if (boxAwbNumbers.length > 0) {
            $('[name="awb-forwarding_number"]').val(boxAwbNumbers.join(', '));
            $('#box_awb_results').text('');
          } else {
            $('#box_awb_results').text('No Box AWB numbers found in the table.');
          }
        }
      
        // Trigger only when box_awb_no input changes
        $('#box_detail').on('input', 'input[name$="-box_awb_no"]', function() {
          if ($('#import_box_awb').is(':checked')) {
            importBoxAWBNumbers();
          }
        });
      });
      
    });
  </script>
  <script>
    $(document).ready(function () {
      // Store the name of the button that was clicked
      let clickedButtonName = null;
      
      // Capture the button click before form submission
      $("#awb_create_form button[type='submit']").on('click', function() {
          clickedButtonName = this.name;
      });
      
      $("#awb_create_form").submit(function (event) {
          event.preventDefault();
          
          // Clean up empty box item rows
          $("#box_item_list tr").each(function () {
              const $row = $(this);
              const unitType = $row.find("[name$='-unit_type']").val();
              const description = $row.find("[name$='-description']").val().trim();
              const hsCode = $row.find("[name$='-hs_code']").val().trim();
              const quantity = $row.find("[name$='-quantity']").val().trim();
              const unitWeight = $row.find("[name$='-unit_weight']").val().trim();
              const unitRate = $row.find("[name$='-unit_rate']").val().trim();
              const amount = $row.find("[name$='-amount']").val().trim();
              const hasOnlyDefaults = 
                  (unitType === "1" || unitType !== "") &&
                  description === "" &&
                  hsCode === "" &&
                  quantity === "" &&
                  (unitWeight == "0" || unitWeight == "0.00" || unitWeight === "") &&
                  unitRate === "" &&
                  (amount === "" || amount === "0" || amount === "0.00");
              if (hasOnlyDefaults) {
                  $row.remove();
                  $row.find('[name$="-DELETE"]').prop('checked', true);
                  $row.hide();
                  const currentTotal = parseInt($('#id_box_item-TOTAL_FORMS').val());
                  $('#id_box_item-TOTAL_FORMS').val(currentTotal - 1);
              }
          });
          
          // If a specific button was clicked, add it back to the form data
          if (clickedButtonName) {
              const hiddenInput = $('<input>').attr({
                  type: 'hidden',
                  name: clickedButtonName,
                  value: 'clicked'
              });
              $(this).append(hiddenInput);
          }
          
          // Submit the form
          this.submit();
      });
  });

  </script>



  <script>
    $(document).ready(function() {
      // Vendor API Call Handler
      $('#call-vendor-api').on('click', function() {
        const awbNo = $(this).data('awb-no');
        const vendorCode = $(this).data('vendor-code');
        const button = $(this);
        
        // Determine API URL based on vendor code
        let apiUrl;
        console.log(vendorCode);
        if (vendorCode === 'DTDC') {
          apiUrl = '{% url "awb:apis:dtdc:awb_dtdc_api" %}';
        } else if (vendorCode === 'SGAU') {
          apiUrl = '{% url "awb:apis:sgau:awb_sgau_api" %}';
        } else if (vendorCode === 'SGUS') {
          apiUrl = '{% url "awb:apis:sgus:awb_sgus_api" %}';
        } else if (vendorCode === 'SGCA') {
          apiUrl = '{% url "awb:apis:sgca:awb_sgca_api" %}';
        } else if (vendorCode === 'COURIERX') {
          apiUrl = '{% url "awb:apis:courierx:awb_courierx_api" %}';
        } else if (vendorCode === 'UBX') {
          apiUrl = '{% url "awb:apis:ubx:awb_ubx_api" %}';
        } else {
          alert('Unsupported vendor code: ' + vendorCode);
          return;
        }
        
        // Show confirmation
        if (!confirm('Are you sure you want to call the ' + vendorCode + ' API for AWB: ' + awbNo + '?')) {
          return;
        }
        
        // Disable button and show loading
        button.prop('disabled', true);
        const originalHtml = button.html();
        button.html('<i class="fi fi-rr-spinner animate-spin"></i><span>Calling API...</span>');
        
        // Make AJAX call
        $.ajax({
          url: apiUrl,
          type: 'GET',
          data: {
            'awbno': awbNo
          },
          success: function(response) {
            showApiResponse(response, true);
          },
          error: function(xhr, status, error) {
            let errorMessage = 'Unknown error occurred';
            try {
              const errorResponse = JSON.parse(xhr.responseText);
              errorMessage = errorResponse.message || errorMessage;
            } catch (e) {
              errorMessage = xhr.status + ': ' + error;
            }
            
            showApiResponse({
              success: false,
              awbno: awbNo,
              message: errorMessage,
              error: true
            }, false);
          },
          complete: function() {
            // Re-enable button
            button.prop('disabled', false);
            button.html(originalHtml);
          }
        });
      });
      
      // Function to show API response in modal
      function showApiResponse(response, isSuccess) {
        const modal = $('#api-response-modal');
        const modalContent = $('#modal-content');
        const modalTitle = $('#modal-title');
        const reloadBtn = $('#reload-page-btn');
        
        // Update modal title based on success/failure
        if (response.success) {
          modalTitle.html('<i class="fi fi-rr-check text-green-500"></i> API Call Successful');
          reloadBtn.removeClass('hidden');
        } else {
          modalTitle.html('<i class="fi fi-rr-cross text-red-500"></i> API Call Failed');
          reloadBtn.addClass('hidden');
        }
        
        // Build response content
        let content = `
          <div class="space-y-4">
            <div class="border-l-4 ${response.success ? 'border-green-500 bg-green-50' : 'border-red-500 bg-red-50'} p-4">
              <div class="flex">
                <div class="flex-shrink-0">
                  <i class="fi ${response.success ? 'fi-rr-check text-green-400' : 'fi-rr-cross text-red-400'} text-xl"></i>
                </div>
                <div class="ml-3">
                  <h4 class="text-sm font-medium ${response.success ? 'text-green-800' : 'text-red-800'}">
                    ${response.success ? 'Success' : 'Error'}
                  </h4>
                  <div class="mt-2 text-sm ${response.success ? 'text-green-700' : 'text-red-700'}">
                    <p><strong>AWB Number:</strong> ${response.awbno}</p>
                    <p><strong>Message:</strong> ${response.message}</p>
                  </div>
                </div>
              </div>
            </div>
        `;
        
        // Add additional response data if available
        if (response.data && Object.keys(response.data).length > 0) {
          content += `
            <div class="mt-4">
              <h5 class="text-sm font-medium text-gray-900 mb-2">API Response Details:</h5>
              <div class="bg-gray-50 rounded-md p-3 max-h-60 overflow-y-auto">
                <pre class="text-xs text-gray-700 whitespace-pre-wrap">${JSON.stringify(response.data, null, 2)}</pre>
              </div>
            </div>
          `;
        }
        
        content += '</div>';
        
        modalContent.html(content);
        modal.removeClass('hidden');
      }
      
      // Modal close handlers
      $('#close-modal, #modal-close-btn').on('click', function() {
        $('#api-response-modal').addClass('hidden');
      });
      
      // Reload page button
      $('#reload-page-btn').on('click', function() {
        location.reload();
      });
      
      // Close modal when clicking outside
      $('#api-response-modal').on('click', function(e) {
        if (e.target === this) {
          $(this).addClass('hidden');
        }
      });
    });
  </script>
{% endblock js %}
