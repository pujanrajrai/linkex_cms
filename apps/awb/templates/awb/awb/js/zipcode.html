<script>
    $(document).ready(function () {
        let activeRequest = null;

        function handleZipCodeInput(zipInputId, countrySelectId, resultsContainerId, cityInputId, stateInputId, stateAbbreviationInputId) {
            const $zipInput = $(zipInputId);
            const $resultsContainer = $(resultsContainerId);

            $zipInput.on("keyup", function () {
                let zipCode = $zipInput.val().trim();
                let countryName = $(countrySelectId + " option:selected").text().trim();

                if (zipCode.length >= 2 && countryName) {
                    if (activeRequest) {
                        activeRequest.abort();
                    }

                    activeRequest = $.ajax({
                        url: "{% url 'awb:pages:master:zipcode:search' %}",
                        method: "GET",
                        data: {
                            term: zipCode,
                            country: countryName
                        },
                        success: function (data) {
                            $resultsContainer.empty();

                            if (data.length > 0) {
                                data.forEach(function (item) {
                                    $resultsContainer.append(`
                                        <div class="item text-sm cursor-pointer p-3 bg-white border-b border-gray-300 hover:bg-blue-100 transition-all duration-200 rounded-md shadow-md"
                                            data-city="${item.city}"
                                            data-zip="${item.zip_code}"
                                            data-state="${item.state}"
                                            data-state_abbreviation="${item.state_abbreviation}">
                                            <strong>${item.city}</strong>, (${item.state}, ${item.state_abbreviation || ''}) (${item.zip_code})
                                        </div>
                                    `);
                                });

                                $resultsContainer
                                    .addClass("bg-white border border-gray-300 shadow-lg rounded-md")
                                    .show();

                                // Highlight the first item
                                $resultsContainer.find('.item:first').addClass('selected bg-blue-100');
                            } else {
                                $resultsContainer.hide();
                            }
                        },
                        error: function () {
                            $resultsContainer.hide();
                        }
                    });
                } else {
                    $resultsContainer.hide();
                }
            });

            // Handle key navigation
            $zipInput.on("keydown", function (e) {
                const selected = $resultsContainer.find('.selected');

                switch (e.keyCode) {
                    case 40: // Down
                        e.preventDefault();
                        const next = selected.next('.item');
                        if (next.length > 0) {
                            selected.removeClass('selected bg-blue-100');
                            next.addClass('selected bg-blue-100');
                            $resultsContainer.scrollTop($resultsContainer.scrollTop() + next.outerHeight());
                        }
                        break;

                    case 38: // Up
                        e.preventDefault();
                        const prev = selected.prev('.item');
                        if (prev.length > 0) {
                            selected.removeClass('selected bg-blue-100');
                            prev.addClass('selected bg-blue-100');
                            $resultsContainer.scrollTop($resultsContainer.scrollTop() - prev.outerHeight());
                        }
                        break;

                    case 13: // Enter
                        e.preventDefault();
                        const selectedItem = $resultsContainer.find('.selected');
                        if (selectedItem.length > 0) {
                            selectedItem.click();
                            $resultsContainer.hide();
                            $zipInput.next('input').focus();
                        }
                        break;
                }
            });

            // Handle click on suggestion
            $resultsContainer.on("click", ".item", function () {
                let selectedCity = $(this).data("city");
                let selectedZip = $(this).data("zip");
                let selectedState = $(this).data("state");
                let selectedStateAbbreviation = $(this).data("state_abbreviation");

                $(cityInputId).val(selectedCity);
                $(zipInputId).val(selectedZip);
                $(stateInputId).val(selectedState);
                $(stateAbbreviationInputId).val(selectedStateAbbreviation);
                $resultsContainer.hide();
            });
        }

        // Initialize both fields
        handleZipCodeInput("#consignor_post_zip_code", "#awb_origin", "#consignor_results", "#consignor_city", "#consignor_state_county", "#consignor_state_abbreviation");
        handleZipCodeInput("#consignee_post_zip_code", "#awb_destination", "#consignee_results", "#consignee_city", "#consignee_state_county", "#consignee_state_abbreviation");

        // Prevent dropdown from hiding when clicking inside inputs or results
        $(document).on("click", function (e) {
            if (!$(e.target).closest("input, .results").length) {
                $(".results").hide();
            }
        });
    });
</script>