<script>
    $(document).ready(function() {
        // Function to re-index all box item rows to ensure unique sequential indices
        function reindexBoxItemRows() {
            const $tbody = $('#box_item_list');
            const $rows = $tbody.find('tr:visible');
            
            $rows.each(function(index) {
                const $row = $(this);
                
                // Update row attributes
                $row.attr('data-index', index);
                $row.attr('name', `box_item-${index}`);
                
                // Update all form field names and IDs
                $row.find('input, select, textarea').each(function() {
                    const $field = $(this);
                    const oldName = $field.attr('name');
                    const oldId = $field.attr('id');
                    
                    if (oldName) {
                        const newName = oldName.replace(/-\d+-/, `-${index}-`);
                        $field.attr('name', newName);
                    }
                    
                    if (oldId) {
                        const newId = oldId.replace(/-\d+-/, `-${index}-`);
                        $field.attr('id', newId);
                    }
                });
            });
            
            // Update management form total count
            $('#id_box_item-TOTAL_FORMS').val($rows.length);
            
            console.log('Box item rows re-indexed. Total rows:', $rows.length);
        }

        // Handle add box item button click
        $(document).on('click', '.add-box-item', function(e) {
            e.preventDefault();
            
            // Get the current row
            const $currentRow = $(this).closest('tr');
            
            // Get the current box number value to clone it
            const currentBoxNumber = $currentRow.find('[name$="-box_number"]').val();
            const currentUnitType = $currentRow.find('[name$="-unit_type"]').val();
            
            // Clone the current row
            const $newRow = $currentRow.clone();
            
            // Get the next available index (always use the total count for new rows)
            const nextIndex = $('#box_item_list tr:visible').length;
            
            // Update the data-index and name attributes with temporary values
            $newRow.attr('data-index', nextIndex);
            $newRow.attr('name', `box_item-${nextIndex}`);
            
            // Update all form field names and IDs to use the new index
            $newRow.find('input, select, textarea').each(function() {
                const $field = $(this);
                const oldName = $field.attr('name');
                const oldId = $field.attr('id');
                
                if (oldName) {
                    const newName = oldName.replace(/-\d+-/, `-${nextIndex}-`);
                    $field.attr('name', newName);
                }
                
                if (oldId) {
                    const newId = oldId.replace(/-\d+-/, `-${nextIndex}-`);
                    $field.attr('id', newId);
                }
                
                // Clear all field values except for box_number and unit_type (clone them)
                if ($field.is('select')) {
                    // For select fields, handle specially
                    if ($field.attr('name').includes('box_number')) {
                        // Keep the same box number as the current row (already cloned)
                    } else if ($field.attr('name').includes('unit_type')) {
                        // Keep the same unit type as the current row (already cloned)
                        $field.val(currentUnitType);
                    } else {
                        $field.val('');
                    }
                } else {
                    // For input fields, clear all values
                    $field.val('');
                }
                
                // Remove any error classes or styling
                $field.removeClass('error border-red-500');
            });
            
            // Clear any error messages in the new row
            $newRow.find('.text-red-500').remove();
            $newRow.removeClass('bg-red-50');
            
            // Update box number dropdown options based on total box count
            const totalBoxes = parseInt($('#total_box_count').val(), 10) || 1;
            const $boxNumberSelect = $newRow.find('[name$="-box_number"]');
            $boxNumberSelect.empty();
            for (let i = 1; i <= totalBoxes; i++) {
                const boxValue = `Box-${i}`;
                const option = new Option(boxValue, boxValue);
                $boxNumberSelect.append(option);
            }
            // Set the box number to the same value as the current row
            $boxNumberSelect.val(currentBoxNumber);
            
            // Insert the new row after the current row
            $currentRow.after($newRow);
            
            // Re-index all rows to ensure proper sequential indices
            reindexBoxItemRows();
            
            // Re-initialize any UI components (like dropdowns) in the new row
            if ($newRow.find('.ui.dropdown').length) {
                $newRow.find('.ui.dropdown').dropdown('destroy').dropdown();
            }
            
            // Trigger change events to ensure proper initialization
            $newRow.find('select').trigger('change');
            
            // Recalculate totals if the function exists
            if (window.recalculateBoxAmounts) {
                window.recalculateBoxAmounts();
            }
            
            // Focus on the first input field in the new row
            $newRow.find('input, select').first().focus();
            
            console.log('New box item row added and re-indexed. Total rows:', $('#box_item_list tr:visible').length);
        });
    });
</script> 