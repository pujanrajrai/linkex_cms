<script>
    $(document).ready(function() {
        // Cache jQuery selectors
        const isError = {{ is_error|yesno:"true,false" }};
        const isUpdating = {{ is_updating|yesno:"true,false" }};

        const $toggleBoxItem = $("#toggle_box_item");
        const $boxItem = $("#box_item");
        const $originSelectors = $('select[id^="awb_origin"]');
        const $destinationSelectors = $('select[id^="awb_destination"]');
        const $consignorCountry = $('#id_consignor-country');
        const $consigneeCountry = $('#id_consignee-country');

        // Box item toggle functionality
        $toggleBoxItem.is(":checked") ? $boxItem.show() : $boxItem.hide();
        $toggleBoxItem.on('change', function() {
            $(this).is(":checked") ? $boxItem.slideDown() : $boxItem.slideUp();
        });

        // Helper function to update dropdowns
        function updateDropdowns($selectors, value) {
            $selectors.each(function() {
                $(this).val(value).dropdown('set selected', String(value));

                if ($(this).attr('id') == 'awb_destination') {
                    updateCountryCode(value);
                }
            });
        }

        $destinationSelectors.each(function() {
            const selectedValue = $(this).val();
            if (selectedValue) {
                updateCountryCode(selectedValue);
            }
        });

        function updateCountryCode(value) {
            $.ajax({
                url: "{% url 'awb:pages:awb:get_country_code' %}",
                type: "GET",
                data: {
                    country_id: value
                },
                success: function(response) {
                    if (response.success && response.country_code) {
                        $("#id_country_code_1").val(response.country_code);
                        $("#id_country_code_2").val(response.country_code);
                    }
                }
            })
        }

        // Origin change handler
        $originSelectors.on('change', function() {
            const selectedOrigin = $(this).val();
            updateDropdowns($originSelectors, selectedOrigin);
            if ($consignorCountry.length) {
                updateDropdowns($consignorCountry, selectedOrigin);
            }
        });

        // Destination change handler
        $destinationSelectors.on('change', function() {
            const selectedDestination = $(this).val();
            updateDropdowns($destinationSelectors, selectedDestination);
            if ($consigneeCountry.length) {
                updateDropdowns($consigneeCountry, selectedDestination);
            }
        });

        // Consignor country change handler
        $consignorCountry.on('change', function() {
            updateDropdowns($originSelectors, $(this).val());
        });

        // Consignee country change handler
        $consigneeCountry.on('change', function() {
            updateDropdowns($destinationSelectors, $(this).val());
        });
    });
</script>
