<script>
    $(document).ready(function() {
        const isError = {{ is_error|yesno:"true,false" }};
        const isUpdating = {{ is_updating|yesno:"true,false" }};
        const isCloned = {{ is_cloned|default:False|yesno:"true,false" }};
        console.log("Is updating: ", isUpdating, "Is Error: ", isError);
        
        const $isCashUserCheckbox = $('#awb_is_cash_user');
        const $agencyField = $('#awb_agency');
        const $agencyContainer = $agencyField.closest('.col-span-12');
        const $clearConsignorDetailsCheckbox = $('#clear_consignor_details');

        // Clear consignor details handler
        $clearConsignorDetailsCheckbox.on('change', function() {
            $(this).is(':checked') ? clearAgencyDependentFields() : fetchAgencyData($agencyField.val());
        });

        function fetchAgencyData(agencyId) {
            const url = "{% url 'awb:pages:awb:agency-api-detail' pk=0 %}".replace('0', agencyId);
            
            $.ajax({
                url: url,
                method: 'GET',
                dataType: 'json',
                success: function(data) {
                    console.log("Agency data fetched:", data);
                    if (data.country_id) {
                        console.log(data.country_id);
                        $('#awb_origin').dropdown('set selected', String(data.country_id));
                        $('#consignor_country').dropdown('set selected', String(data.country_id));
                    }

                    // Auto-fill consignor fields
                    const fields = {
                        '#consignor_company': data.name,
                        '#consignor_email': data.email,
                        '#consignor_person_name': data.owner_name,
                        '#consignor_phone_number': data.contact_no_1,
                        '#consignor_email_address': data.email,
                        '#consignor_city': data.city,
                        '#consignor_state_county': data.state,
                        '#consignor_post_zip_code': data.zip_code,
                        '#consignor_address1': data.address1,
                        '#consignor_address2': data.address2
                    };
                    Object.entries(fields).forEach(([selector, value]) => {
                        $(selector).val(value);
                    });
                    const creditLimit = parseFloat(data.credit_limit)*(-1); // make credit limit negative
                    const lastBalance = parseFloat(data.last_balance);

                    if (lastBalance >= creditLimit) {
                        $('#agency-balance-display')
                            .text('(Balance: Rs. ' + lastBalance + ')')
                            .css('color', 'inherit')
                            .css('font-size', '');
                    } else {
                        $('#agency-balance-display')
                            .text('(Balance: Rs. ' + lastBalance + ' - Limit Over)')
                            .css('color', 'red')
                            .css('font-size', '10px');
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error('Error fetching agency data:', textStatus, errorThrown);
                }
            });
        }

        

        function handleCashUserChange() {
            if ($isCashUserCheckbox.is(':checked')) {
                $agencyContainer.hide();
                $agencyField.dropdown('clear');
                if (!isError) {
                    console.log("GOT HERE");
                    clearAgencyDependentFields();
                }
            } else {
                $agencyContainer.show();
                const agencyId = $agencyField.val();
                if (agencyId) {
                    handleAgencyChange(agencyId);
                }
            }
        }

        function clearAgencyDependentFields() {
            if ($clearConsignorDetailsCheckbox.is(':checked') || (!isError && !isUpdating && !isCloned)) {
                const fields = [
                    '#consignor_company',
                    '#consignor_email',
                    '#consignor_person_name',
                    '#consignor_phone_number',
                    '#consignor_email_address',
                    '#consignor_city',
                    '#consignor_state_county',
                    '#consignor_post_zip_code',
                    '#consignor_address1',
                    '#consignor_address2'
                ];
    
                fields.forEach(selector => $(selector).val(''));
                $('#agency-balance-display').text('');
    
                try {
                    $('#awb_origin').dropdown('clear');
                    $('#consignor_country').dropdown('clear');
                } catch(e) {
                    console.log("Dropdown plugin not available or already cleared");
                }
            }
        }

        function handleAgencyChange() {
            const agencyId = $agencyField.val();
            if (agencyId && !$isCashUserCheckbox.is(':checked')) {
                fetchAgencyData(agencyId);
            }
        }

        // Bind event handlers
        $isCashUserCheckbox.on('change', handleCashUserChange);
        $agencyField.on('change', function() {
            if (!$(this).val()) {
                if (!isError) {
                    console.log("GOT HERE 2");
                    clearAgencyDependentFields();
                }
            }
            handleAgencyChange();
        });

        // Initialize state
        if ($isCashUserCheckbox.is(':checked')) {
            handleCashUserChange();
        } else if ($agencyField.val()) {
            handleAgencyChange();
        }

       
    });
</script>
