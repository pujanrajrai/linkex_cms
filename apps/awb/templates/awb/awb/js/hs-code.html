<script>
    let currentContainer = null;

    function getResultContainerId(rowIndex) {
        return `hs-code-results-${rowIndex}`;
    }

    let currentResultContainer = null;
    const $contentField = $('#awb_content');

    function updateContentField() {
        // Only update if checkbox is checked
        if ($('#import_box_items').is(':checked')) {
            // Collect all description values
            const descriptions = [];
            $('input[name$="-description"]').each(function() {
                const value = $(this).val().trim();
                if (value) {
                    descriptions.push(value);
                }
            });
            
            // Join descriptions with commas and update the content field
            $contentField.val(descriptions.join(', '));
        }
    }

    // Handle checkbox change
    $('#import_box_items').change(function() {
        if ($(this).is(':checked')) {
            updateContentField();
        }
    });

    $(document).on('input', 'input[name$="-description"]', function() {
        const input = $(this)
        const query = input.val().trim()
        const row = input.closest('tr')
        const rowIndex = row.data('index')

        if (query.length < 2) {
            $(`#${getResultContainerId(rowIndex)}`).remove()
            return;
        }

        let resultsContainer = $(`#${getResultContainerId(rowIndex)}`);
        if (resultsContainer.length === 0) {
            resultsContainer = $('<div>', {
                id: getResultContainerId(rowIndex),
                class: 'absolute bg-white border border-gray-300 rounded-md shadow-lg z-50 w-full max-h-60 overflow-y-auto',
                css: {
                    'top': input.position().top + input.outerHeight(),
                    'left': input.position().left,
                    'width': input.closest('td').width()
                }
            });
            input.closest('td').css('position', 'relative').append(resultsContainer);
            currentResultContainer = resultsContainer;
        }

        resultsContainer.html('<div class="p-3 text-center">Loading...</div>');

        $.ajax({
            url: "{% url 'awb:pages:master:hscode:search_hscode' %}",
            data: { query: query },
            dataType: 'json',
            success: function(data) {
                resultsContainer.empty();

                if (data.length === 0) {
                    return;
                }

                data.forEach(function(item) {
                    const resultItem = $(`
                        <div class="item cursor-pointer p-3 bg-white border-b border-gray-300 hover:bg-blue-100 transition-all duration-200 rounded-md shadow-md" data-code="${item.code}" data-description="${item.description}">
                        <strong>${item.code}</strong>: ${item.description}
                        </div>
                    `);
                    
                    resultsContainer.append(resultItem);
                });

                // Add selected class to first item
                resultsContainer.find('.item:first').addClass('selected bg-blue-100');

                // Handle keyboard navigation
                input.on('keydown', function(e) {
                    const selected = resultsContainer.find('.selected');
                    const items = resultsContainer.find('.item');
                    
                    switch(e.keyCode) {
                        case 40: // Down arrow
                            e.preventDefault();
                            if (selected.length > 0) {
                                const next = selected.next('.item');
                                if (next.length > 0) {
                                    selected.removeClass('selected bg-blue-100');
                                    next.addClass('selected bg-blue-100');
                                    
                                    // Scroll into view if needed
                                    if (next.position().top + next.height() > resultsContainer.height()) {
                                        resultsContainer.scrollTop(resultsContainer.scrollTop() + next.height());
                                    }
                                }
                            }
                            break;

                        case 38: // Up arrow
                            e.preventDefault();
                            if (selected.length > 0) {
                                const prev = selected.prev('.item');
                                if (prev.length > 0) {
                                    selected.removeClass('selected bg-blue-100');
                                    prev.addClass('selected bg-blue-100');
                                    
                                    // Scroll into view if needed
                                    if (prev.position().top < 0) {
                                        resultsContainer.scrollTop(resultsContainer.scrollTop() - prev.height());
                                    }
                                }
                            }
                            break;

                        case 13: // Enter
                            e.preventDefault();
                            if (selected.length > 0) {
                                selected.click();
                            }
                            break;
                    }
                });
            },
            error: function() {
                return;
            }
        });

        // Handle clicks on result items
        resultsContainer.on('click', '.item', function() {
            const selected = $(this);
            const code = selected.data('code');
            const description = selected.data('description');
            
            // Fill in the values in the current row only
            const targetRow = row; // Use the row from the current context
            targetRow.find('input[name$="-description"]').val(description);
            targetRow.find('input[name$="-hs_code"]').val(code);

            // Only update content field if checkbox is checked
            if ($('#import_box_items').is(':checked')) {
                updateContentField();
            }
            
            // Remove the results container
            resultsContainer.remove();
            
            // Clear any keyboard event handlers on the input
            input.off('keydown');
        });

        // Only update content field on input/blur if checkbox is checked
        $(document).on('input blur', 'input[name$="-description"]', function() {
            if ($('#import_box_items').is(':checked')) {
                updateContentField();
            }
        });
        
        // Close results when clicking outside
        $(document).on('click', function(event) {
            if (currentResultContainer && 
                !$(event.target).closest('input[name$="-description"]').length && 
                !$(event.target).closest(`[id^="hs-code-results-"]`).length) {
                $('[id^="hs-code-results-"]').remove();
                currentResultContainer = null;
            }
        });
        
        // Close results container when pressing Escape
        $(document).on('keydown', function(event) {
            if (event.key === 'Escape' && currentResultContainer) {
                $('[id^="hs-code-results-"]').remove();
                currentResultContainer = null;
            }
        });
    })
</script>
