<!-- Box Detail Script -->
<script>
    $(document).ready(function () {
        // Function to round up to nearest 0.5
        function roundToNearestHalf(value) {
            // Get the decimal part
            const decimal = value - Math.floor(value);
            
            // Round up to nearest 0.5
            if (decimal === 0) {
                return value; // Already a whole number
            } else if (decimal <= 0.5) {
                return Math.floor(value) + 0.5; // Round up to x.5
            } else {
                return Math.ceil(value); // Round up to next whole number
            }
        }
        
        // Function to generate a box detail row
        function createBoxDetailRow(index) {
            return `
                <tr data-index="${index}" class="border-t box-form">
                 
                    <td class="border border-gray-300 px-2 py-1">
                        <input type="text" tabindex="-1" name="box_details-${index}-box_number" class="peer block w-full appearance-none border border-gray-300 px-3 pt-1 pb-1 text-gray-800 bg-gray-300 rounded-md" readonly value="Box-${index + 1}">
                    </td>
                    <td class="border border-gray-300 px-2 py-1">
                        <input type="number" step="0.01" name="box_details-${index}-length" class="peer block w-full appearance-none border border-gray-300 px-3 pt-1 pb-1 text-gray-800 bg-white rounded-md" required>
                    </td>
                    <td class="border border-gray-300 px-2 py-1">
                        <input type="number" step="0.01" name="box_details-${index}-breadth" class="peer block w-full appearance-none border border-gray-300 px-3 pt-1 pb-1 text-gray-800 bg-white rounded-md" required>
                    </td>
                    <td class="border border-gray-300 px-2 py-1">
                        <input type="number" step="0.01" name="box_details-${index}-height" class="peer block w-full appearance-none border border-gray-300 px-3 pt-1 pb-1 text-gray-800 bg-white rounded-md" required>
                    </td>
                    <td class="border border-gray-300 px-2 py-1">
                        <input type="number" step="0.01" name="box_details-${index}-actual_weight" class="peer block w-full appearance-none border border-gray-300 px-3 pt-1 pb-1 text-gray-800 bg-white rounded-md" required>
                        <input type="hidden" name="box_details-${index}-rounded_actual_weight" class="rounded-actual-weight">
                    </td>
                    <td class="border border-gray-300 px-2 py-1">
                        <input type="number" step="0.01" tabindex="-1" name="box_details-${index}-volumetric_weight" class="peer block w-full appearance-none border border-gray-300 px-3 pt-1 pb-1 text-gray-800 bg-gray-300 rounded-md" readonly>
                    </td>
                    <td class="border border-gray-300 px-2 py-1">
                        <input type="number" step="0.01" tabindex="-1" name="box_details-${index}-charged_weight" class="peer block w-full appearance-none border border-gray-300 px-3 pt-1 pb-1 text-gray-800 bg-gray-300 rounded-md" readonly>
                    </td>
                    <td class="border border-gray-300 px-2 py-1 flex gap-2">
                        <button type="button"
                                tabindex="-1"
                                title="Add Box Detail"
                                id="add-box-detail"
                                class="add-box-detail bg-green-500 text-white px-3 py-1 rounded-md hover:bg-green-600 text-sm">
                                <i class="fi fi-rr-plus"></i>
                        </button>
                        <button type="button"
                                tabindex="-1"
                                class="remove-box-detail bg-red-500 text-white px-3 py-1 rounded-md hover:bg-red-600 text-sm">
                        Remove
                        </button>
                    </td>
                </tr>
            `;
        }

        // Function to calculate weights for a box
        function calculateWeights($row) {
            let length = parseFloat($row.find("[name$='-length']").val()) || 0;
            let breadth = parseFloat($row.find("[name$='-breadth']").val()) || 0;
            let height = parseFloat($row.find("[name$='-height']").val()) || 0;
            let actualWeight = parseFloat($row.find("[name$='-actual_weight']").val()) || 0;
            let dividingFactor = parseFloat($("#box_total_dividing_factor").val()) || 5000;

            // Calculate Volumetric Weight
            let volumetricWeight = (length * breadth * height) / dividingFactor;
            
            // Round weights for calculations
            let roundedActualWeight = roundToNearestHalf(actualWeight);
            let roundedVolumetricWeight = roundToNearestHalf(volumetricWeight);

            // Store rounded actual weight in hidden field
            $row.find("[name$='-rounded_actual_weight']").val(roundedActualWeight);

            // Calculate Charged Weight (max of rounded actual and volumetric)
            let chargedWeight = Math.max(roundedActualWeight, roundedVolumetricWeight);
            
            // Format for display
            let volumetricWeightFormatted = roundedVolumetricWeight.toFixed(2);
            let chargedWeightFormatted = chargedWeight.toFixed(2);

            // Update the fields - don't update actual_weight to allow editing
            $row.find("[name$='-volumetric_weight']").val(volumetricWeightFormatted);
            $row.find("[name$='-charged_weight']").val(chargedWeightFormatted);
        }

        // Function to calculate all weights and update totals
        function calculateAllWeights() {
            let totalActualWeight = 0;
            let totalRoundedActualWeight = 0;
            let totalVolumetricWeight = 0;
            let totalChargedWeight = 0;

            $('#box_detail tr').each(function() {
                let $row = $(this);
                calculateWeights($row);

                let actualWeight = parseFloat($row.find("[name$='-actual_weight']").val()) || 0;
                let roundedActualWeight = parseFloat($row.find("[name$='-rounded_actual_weight']").val()) || 0;
                let volumetricWeight = parseFloat($row.find("[name$='-volumetric_weight']").val()) || 0;
                let chargedWeight = parseFloat($row.find("[name$='-charged_weight']").val()) || 0;

                totalActualWeight += actualWeight;
                totalRoundedActualWeight += roundedActualWeight;
                totalVolumetricWeight += volumetricWeight;
                totalChargedWeight += chargedWeight;
            });
            
            // Update totals in footer of the box details table
            $('#box_detail').closest('table').find('tfoot tr th:nth-child(5)').text('Total A.WT: ' + totalRoundedActualWeight.toFixed(2));
            $('#box_detail').closest('table').find('tfoot tr th:nth-child(6)').text('Total V. WGT: ' + totalVolumetricWeight.toFixed(2));
            $('#box_detail').closest('table').find('tfoot tr th:nth-child(7)').text('Total C.WT: ' + totalChargedWeight.toFixed(2));
        }

        // Function to update box details
        function updateBoxDetails(boxCount) {
            const tbody = $('#box_detail');
            const currentRows = tbody.find('tr').length;
            
            // Calculate difference in rows needed
            const rowDiff = boxCount - currentRows;

            if (rowDiff > 0) {
                // Add new rows
                for (let i = currentRows; i < boxCount; i++) {
                    tbody.append(createBoxDetailRow(i));
                }
            } else if (rowDiff < 0) {
                // Remove excess rows from the end
                tbody.find('tr').slice(boxCount).remove();
            }

            // Recalculate weights after updating rows
            calculateAllWeights();
        }

        // Event handler for weight-related input changes
        $(document).on('input', '[name$="-length"], [name$="-breadth"], [name$="-height"], [name$="-actual_weight"]', function() {
            calculateWeights($(this).closest('tr'));
            calculateAllWeights();
        });

        // Event handler for dividing factor change
        $('#box_total_dividing_factor').on('change', calculateAllWeights);

        // Make functions available globally for the box item script
        window.boxDetailFunctions = {
            updateBoxDetails: updateBoxDetails,
            calculateAllWeights: calculateAllWeights
        };
    });
</script>
<script>
    $(document).ready(function () {
        // Handle Add Box Detail button click
        $(document).on('click', '.add-box-detail', function () {
            let currentCount = parseInt($('#total_box_count').val(), 10) || 0;
            $('#total_box_count').val(currentCount + 1).trigger('change');
        });

        // Handle Remove Box Detail button click
        $(document).on('click', '.remove-box-detail', function () {
            let currentCount = parseInt($('#total_box_count').val(), 10) || 0;
            if (currentCount > 1) {
            $('#total_box_count').val(currentCount - 1).trigger('change');
            }
        });

        // Event handler for total box count change
        $('#total_box_count').on('change', function () {
            const totalBoxes = parseInt($(this).val(), 10) || 0;
            // Update TOTAL_FORMS value
            $('#id_box_details-TOTAL_FORMS').val(totalBoxes);
            
            // Call functions from both box detail and box item scripts
            window.boxDetailFunctions.updateBoxDetails(totalBoxes);
            if (window.boxItemFunctions) {
                window.boxItemFunctions.updateBoxItemRows(totalBoxes);
            }
        });

        // Initialize on page load
        let boxCount = $('#total_box_count').val().trim();
        if (boxCount === "" || parseInt(boxCount, 10) <= 0) {
            boxCount = 1;
            $('#total_box_count').val(boxCount);
            $('#id_box_details-TOTAL_FORMS').val(boxCount);
        } else {
            boxCount = parseInt(boxCount, 10);
            $('#id_box_details-TOTAL_FORMS').val(boxCount);
        }
            
        // Initialize box details and items based on boxCount
        window.boxDetailFunctions.updateBoxDetails(boxCount);
    });
</script>
<script>
    $(document).ready(function() {
        // Function to update box number dropdown options based on total box count
        function updateBoxItemDropdowns(boxCount) {
            console.log("Updating box number dropdowns with count:", boxCount);
            $('#box_item_list tr').each(function() {
                const $boxNumberSelect = $(this).find('[name$="-box_number"]');
                const currentValue = $boxNumberSelect.val();
                $boxNumberSelect.empty();
                for (let i = 1; i <= boxCount; i++) {
                    const boxValue = `Box-${i}`;
                    const option = new Option(boxValue, boxValue);
                    $boxNumberSelect.append(option);
                }
                if (currentValue && parseInt(currentValue.replace('Box-', '')) <= boxCount) {
                    $boxNumberSelect.val(currentValue);
                } else {
                    $boxNumberSelect.val(`Box-1`);
                }
                if (!$boxNumberSelect.val()) {
                    $boxNumberSelect.val(`Box-1`);
                }
                if ($boxNumberSelect.hasClass('ui dropdown')) {
                    $boxNumberSelect.dropdown('refresh');
                }
                console.log("After update:", $boxNumberSelect.attr('name'), "Value:", $boxNumberSelect.val());
            });
        }
        
        // Function to create box item rows based on total box count
        function updateBoxItemRows(boxCount) {
            console.log("Updating box item rows with count:", boxCount);
            const $tbody = $('#box_item_list');
            const currentRows = $tbody.find('tr').length;
            
            // Update box number dropdown options for all existing rows
            $tbody.find('tr').each(function(index) {
                const $row = $(this);
                const $boxNumberSelect = $row.find('[name$="-box_number"]');
                const currentBoxNumber = $boxNumberSelect.val(); // Preserve current selection
                
                // Update dropdown options
                $boxNumberSelect.empty();
                for (let i = 1; i <= boxCount; i++) {
                    const boxValue = `Box-${i}`;
                    const option = new Option(boxValue, boxValue);
                    $boxNumberSelect.append(option);
                }
                
                // Preserve the current box number if it's still valid, otherwise default to Box-1
                if (currentBoxNumber && parseInt(currentBoxNumber.replace('Box-', '')) <= boxCount) {
                    $boxNumberSelect.val(currentBoxNumber);
                } else {
                    $boxNumberSelect.val('Box-1');
                }
                
                // Update row attributes and form field names based on current index
                $row.attr('data-index', index);
                $row.attr('name', `box_item-${index}`);
                
                // Update form field names and IDs
                $row.find('input, select, textarea').each(function() {
                    const $field = $(this);
                    const oldName = $field.attr('name');
                    const oldId = $field.attr('id');
                    
                    if (oldName) {
                        const newName = oldName.replace(/-\d+-/, `-${index}-`);
                        $field.attr('name', newName);
                    }
                    
                    if (oldId) {
                        const newId = oldId.replace(/-\d+-/, `-${index}-`);
                        $field.attr('id', newId);
                    }
                });
            });
            
            // Ensure at least one box item exists for each box number
            for (let boxNum = 1; boxNum <= boxCount; boxNum++) {
                const boxValue = `Box-${boxNum}`;
                let hasBoxItem = false;
                
                // Check if this box number already exists
                $tbody.find('tr').each(function() {
                    const $existingRow = $(this);
                    const existingBoxNumber = $existingRow.find('[name$="-box_number"]').val();
                    if (existingBoxNumber === boxValue) {
                        hasBoxItem = true;
                        return false; // break the loop
                    }
                });
                
                // If no box item exists for this box number, create one
                if (!hasBoxItem) {
                    const newIndex = $tbody.find('tr').length;
                    const $newRow = createBoxItemRow(newIndex, boxValue);
                    $tbody.append($newRow);
                    console.log(`Added new box item for ${boxValue} at index ${newIndex}`);
                }
            }
            
            // Update management form with actual number of rows
            const finalRowCount = $tbody.find('tr').length;
            $('#id_box_item-TOTAL_FORMS').val(finalRowCount);
            
            // Re-index all rows after adding new ones
            $tbody.find('tr').each(function(index) {
                const $row = $(this);
                
                // Update row attributes
                $row.attr('data-index', index);
                $row.attr('name', `box_item-${index}`);
                
                // Update form field names and IDs
                $row.find('input, select, textarea').each(function() {
                    const $field = $(this);
                    const oldName = $field.attr('name');
                    const oldId = $field.attr('id');
                    
                    if (oldName) {
                        const newName = oldName.replace(/-\d+-/, `-${index}-`);
                        $field.attr('name', newName);
                    }
                    
                    if (oldId) {
                        const newId = oldId.replace(/-\d+-/, `-${index}-`);
                        $field.attr('id', newId);
                    }
                });
            });
            
            // Update final management form count
            $('#id_box_item-TOTAL_FORMS').val($tbody.find('tr').length);
            
            // Recalculate totals
            if (window.recalculateBoxAmounts) {
                window.recalculateBoxAmounts();
            }
        }

        // Handle remove box item button click
        $(document).on('click', '.remove-box-item', function(e) {
            e.preventDefault();
            
            const $row = $(this).closest('tr');
            const totalRows = $('#box_item_list tr').length;
            
            // Don't allow removing if it's the only row
            if (totalRows <= 1) {
                alert('Cannot remove the last box item row. At least one row is required.');
                return;
            }
            
            // If this is an existing database record, mark it for deletion
            const $deleteField = $row.find('[name$="-DELETE"]');
            if ($deleteField.length && $row.find('[name$="-id"]').val()) {
                // This is an existing record, mark for deletion instead of removing
                $deleteField.prop('checked', true);
                $row.hide();
                console.log('Existing box item marked for deletion');
            } else {
                // This is a new row, safe to remove completely
                $row.remove();
                
                // Update form indices for remaining rows
                $('#box_item_list tr:visible').each(function(index) {
                    const $remainingRow = $(this);
                    
                    // Update row attributes
                    $remainingRow.attr('data-index', index);
                    $remainingRow.attr('name', `box_item-${index}`);
                    
                    // Update form field names and IDs
                    $remainingRow.find('input, select, textarea').each(function() {
                        const $field = $(this);
                        const oldName = $field.attr('name');
                        const oldId = $field.attr('id');
                        
                        if (oldName) {
                            const newName = oldName.replace(/-\d+-/, `-${index}-`);
                            $field.attr('name', newName);
                        }
                        
                        if (oldId) {
                            const newId = oldId.replace(/-\d+-/, `-${index}-`);
                            $field.attr('id', newId);
                        }
                    });
                });
                
                // Update management form total count
                const newTotal = $('#box_item_list tr:visible').length;
                $('#id_box_item-TOTAL_FORMS').val(newTotal);
                console.log('New box item row removed. New total:', newTotal);
            }
            
            // Recalculate totals
            if (window.recalculateBoxAmounts) {
                window.recalculateBoxAmounts();
            } else {
                updateTotalAmount();
            }
        });
        
        // Function to create a new box item row
        function createBoxItemRow(index, boxNumber) {
            const $existingRow = $('#box_item_list tr').first();
            let $newRow;
            
            if ($existingRow.length) {
                // Clone existing row and clear values
                $newRow = $existingRow.clone();
                
                // Store the current unit type value before clearing
                const currentUnitType = $existingRow.find('[name$="-unit_type"]').val();
                
                $newRow.find('input, select, textarea').each(function() {
                    const $field = $(this);
                    if ($field.is('select')) {
                        if ($field.attr('name').includes('unit_type')) {
                            // Keep the unit type selection from the original row
                            $field.val(currentUnitType);
                        }
                        // Don't clear box_number - it will be set later
                    } else {
                        // Clear all input values
                        $field.val('');
                    }
                    $field.removeClass('error border-red-500');
                });
                $newRow.find('.text-red-500').remove();
                $newRow.removeClass('bg-red-50');
            } else {
                // Create a basic row structure if no existing row
                $newRow = $(`
                    <tr data-index="${index}" class="border-t" name="box_item-${index}">
                        <td class="border border-gray-300 px-2 py-1">
                            <select name="box_item-${index}-box_number" id="id_box_item-${index}-box_number" class="peer block w-full border border-gray-300 px-3 py-1 text-sm rounded-md">
                                <option value="${boxNumber}">${boxNumber}</option>
                            </select>
                        </td>
                        <td class="border border-gray-300 px-2 py-1">
                            <input type="text" name="box_item-${index}-description" id="id_box_item-${index}-description" class="peer block w-full border border-gray-300 px-3 py-1 text-sm rounded-md">
                        </td>
                        <td class="border border-gray-300 px-2 py-1">
                            <input type="text" name="box_item-${index}-hs_code" id="id_box_item-${index}-hs_code" class="peer block w-full border border-gray-300 px-3 py-1 text-sm rounded-md">
                        </td>
                        <td class="border border-gray-300 px-2 py-1">
                            <select name="box_item-${index}-unit_type" id="id_box_item-${index}-unit_type" class="peer block w-full border border-gray-300 px-3 py-1 text-sm rounded-md">
                                <option value="1" selected>PCS</option>
                            </select>
                        </td>
                        <td class="border border-gray-300 px-2 py-1">
                            <input type="number" name="box_item-${index}-quantity" id="id_box_item-${index}-quantity" class="peer block w-full border border-gray-300 px-3 py-1 text-sm rounded-md" step="0.01">
                        </td>
                        <td class="border border-gray-300 px-2 py-1">
                            <input type="number" name="box_item-${index}-unit_weight" id="id_box_item-${index}-unit_weight" class="peer block w-full border border-gray-300 px-3 py-1 text-sm rounded-md" step="0.01">
                        </td>
                        <td class="border border-gray-300 px-2 py-1">
                            <input type="number" name="box_item-${index}-unit_rate" id="id_box_item-${index}-unit_rate" class="peer block w-full border border-gray-300 px-3 py-1 text-sm rounded-md" step="0.01">
                        </td>
                        <td class="border border-gray-300 px-2 py-1">
                            <input type="number" name="box_item-${index}-amount" id="id_box_item-${index}-amount" class="peer block w-full border border-gray-300 px-3 py-1 text-sm rounded-md" step="0.01" readonly>
                        </td>
                        <td class="border border-gray-300 px-2 py-1 flex gap-2">
                            <button type="button" tabindex="-1" title="Add Box Item" class="add-box-item bg-green-500 text-white px-3 py-1 rounded-md hover:bg-green-600 text-sm">
                                <i class="fi fi-rr-clone"></i>
                            </button>
                            <button type="button" tabindex="-1" class="remove-box-item bg-red-500 text-white px-3 py-1 rounded-md hover:bg-red-600 text-sm">
                                Remove
                            </button>
                        </td>
                    </tr>
                `);
            }
            
            // Set the box number for the new row
            const boxCount = parseInt($('#total_box_count').val(), 10) || 1;
            const $boxNumberSelect = $newRow.find('[name$="-box_number"]');
            $boxNumberSelect.empty();
            for (let i = 1; i <= boxCount; i++) {
                const boxValue = `Box-${i}`;
                const option = new Option(boxValue, boxValue);
                $boxNumberSelect.append(option);
            }
            $boxNumberSelect.val(boxNumber);
            
            return $newRow;
        }

        function areAllFieldsFilled($row) {
            let allFilled = true;
            const requiredFields = $row.find('[name$="-description"], [name$="-quantity"], [name$="-unit_rate"]');
            requiredFields.each(function() {
                if ($(this).val() === '' || $(this).val() === null) {
                    allFilled = false;
                    return false;
                }
            });
            return allFilled;
        }

        function calculateAmount($row) {
            const quantity = parseFloat($row.find('[name$="-quantity"]').val()) || 0;
            const unitRate = parseFloat($row.find('[name$="-unit_rate"]').val()) || 0;
            const amount = quantity * unitRate;
            $row.find('[name$="-amount"]').val(amount.toFixed(2));
            
            // Use the global recalculateBoxAmounts function if available
            if (window.recalculateBoxAmounts) {
                window.recalculateBoxAmounts();
            } else {
                updateTotalAmount();
            }
        }
        
        // Function to update the total amount and shipment value
        function updateTotalAmount() {
            let totalAmount = 0;
            console.log("Calculating total amount...");
            $('#box_item_list tr:visible').each(function() {
                const $row = $(this);
                const amount = parseFloat($row.find('[name$="-amount"]').val()) || 0;
                console.log(`Row amount: ${amount}`);
                totalAmount += amount;
            });
            console.log("Total amount calculated:", totalAmount.toFixed(2));
            // Update the footer cell
            $('#totalAmountCell').text('Total Amount: ' + totalAmount.toFixed(2));
            
            // Update the shipment value input only if the checkbox is checked
            if ($("#toggle_box_item").is(":checked")) {
                $('#id_shipment_value, #awb_shipment_value').val(totalAmount.toFixed(2));
            }
        }

        function addNewRowIfNeeded() {
            console.log("Checking if new row is needed...");
            const $lastRow = $('#box_item_list tr:last');
            if ($lastRow.length && areAllFieldsFilled($lastRow)) {
                const currentIndex = parseInt($lastRow.attr('data-index') || $lastRow.index());
                const nextIndex = currentIndex + 1;
                console.log("Creating new row with index:", nextIndex);
                const boxNumber = $lastRow.find('[name$="-box_number"]').val();
                const unitType = $lastRow.find('[name$="-unit_type"]').val();
                const $newRow = $lastRow.clone();
                $newRow.attr('data-index', nextIndex);
                $newRow.attr('name', `box_item-${nextIndex}`);
                $newRow.find('input, select').each(function() {
                    const oldName = $(this).attr('name');
                    const oldId = $(this).attr('id');
                    if (oldName) {
                        const newName = oldName.replace(/-\d+-/, `-${nextIndex}-`);
                        $(this).attr('name', newName);
                    }
                    if (oldId) {
                        const newId = oldId.replace(/-\d+-/, `-${nextIndex}-`);
                        $(this).attr('id', newId);
                    }
                    // Clear all input values except box_number and unit_type
                    if (!$(this).is('select') && !$(this).attr('name').includes('box_number') && !$(this).attr('name').includes('unit_type')) {
                        $(this).val('');
                    }
                });
                const boxCount = parseInt($('#total_box_count').val(), 10) || 1;
                const $boxNumberSelect = $newRow.find('[name$="-box_number"]');
                $boxNumberSelect.empty();
                for (let i = 1; i <= boxCount; i++) {
                    const boxValue = `Box-${i}`;
                    const option = new Option(boxValue, boxValue);
                    $boxNumberSelect.append(option);
                }
                $boxNumberSelect.val(boxNumber);
                // Ensure unit type is properly set
                const $unitTypeSelect = $newRow.find('[name$="-unit_type"]');
                $unitTypeSelect.val(unitType);
                console.log("Set unit type to:", unitType, "Current value:", $unitTypeSelect.val());
                
                const currentTotal = parseInt($('#id_box_item-TOTAL_FORMS').val() || '0');
                $('#id_box_item-TOTAL_FORMS').val(currentTotal + 1);
                $('#box_item_list').append($newRow);
                if ($newRow.find('.ui.dropdown').length) {
                    $newRow.find('.ui.dropdown').dropdown('destroy').dropdown();
                } else {
                    $newRow.find('select').trigger('change');
                }
                $newRow.attr('data-unit-type', unitType);
                
                // Use the global recalculateBoxAmounts function if available
                if (window.recalculateBoxAmounts) {
                    window.recalculateBoxAmounts();
                } else {
                    updateTotalAmount();
                }
            }
        }

        $(document).on('input', '[name$="-quantity"], [name$="-unit_rate"]', function() {
            calculateAmount($(this).closest('tr'));
            addNewRowIfNeeded();
        });

        $(document).on('blur', '#box_item_list input, #box_item_list select', function() {
            addNewRowIfNeeded();
        });

        // Calculate amounts for existing rows
        $('#box_item_list tr').each(function() {
            calculateAmount($(this));
        });
        
        // Use the global recalculateBoxAmounts function if available
        if (window.recalculateBoxAmounts) {
            window.recalculateBoxAmounts();
        } else {
            updateTotalAmount();
        }
        
        const initialBoxCount = parseInt($('#total_box_count').val(), 10) || 1;
        updateBoxItemDropdowns(initialBoxCount);
        
        // Toggle box item section visibility based on checkbox
        $("#toggle_box_item").on("change", function() {
            const isChecked = $(this).is(":checked");
            
            // If unchecked, make shipment value editable
            $("#id_shipment_value, #awb_shipment_value").prop("readonly", isChecked);
            
            if (isChecked) {
                // If checked, update with calculated total and add readonly styling
                if (window.recalculateBoxAmounts) {
                    window.recalculateBoxAmounts();
                } else {
                    updateTotalAmount();
                }
                $("#id_shipment_value, #awb_shipment_value").addClass("bg-gray-100");
            } else {
                // If unchecked, remove readonly styling
                $("#id_shipment_value, #awb_shipment_value").removeClass("bg-gray-100");
            }
        });
        
        // Initialize the readonly state based on initial checkbox state
        $("#id_shipment_value, #awb_shipment_value").prop("readonly", $("#toggle_box_item").is(":checked"));
        if ($("#toggle_box_item").is(":checked")) {
            $("#id_shipment_value, #awb_shipment_value").addClass("bg-gray-100");
        }
        
        window.boxItemFunctions = {
            console.log("x"*10000)
            updateBoxItemDropdowns: updateBoxItemDropdowns,
            updateBoxItemRows: updateBoxItemRows,
            addNewRowIfNeeded: addNewRowIfNeeded,
            calculateAmount: calculateAmount,
            createBoxItemRow: createBoxItemRow
        };
    });
</script>
<!-- Additional script to ensure box number dropdowns are initialized properly -->
<script>
    $(document).ready(function() {
        setTimeout(function() {
            const boxCount = parseInt($('#total_box_count').val(), 10) || 1;
            
            // Use the new updateBoxItemRows function if available
            if (window.boxItemFunctions && window.boxItemFunctions.updateBoxItemRows) {
                window.boxItemFunctions.updateBoxItemRows(boxCount);
            } else {
                // Fallback to old method
                $('#box_item_list tr').each(function() {
                    const $select = $(this).find('[name$="-box_number"]');
                    if ($select.find('option').length === 0) {
                        for (let i = 1; i <= boxCount; i++) {
                            const boxValue = `Box-${i}`;
                            $select.append(new Option(boxValue, boxValue));
                        }
                    }
                    if (!$select.val()) {
                        $select.val('Box-1');
                    }
                });
            }
            
            // Trigger calculation after initialization
            if (window.recalculateBoxAmounts) {
                window.recalculateBoxAmounts();
            }
        }, 100);
    });
</script>
<!-- Script to ensure unit type handling and update calculations properly -->
<script>
    $(document).ready(function() {
        window.boxDetailFunctions.calculateAllWeights();
        $(document).on('input', '#box_detail [name$="-length"], #box_detail [name$="-breadth"], #box_detail [name$="-height"], #box_detail [name$="-actual_weight"]', function() {
            console.log("Dimension changed:", $(this).attr('name'), "Value:", $(this).val());
            const $row = $(this).closest('tr');
            window.boxDetailFunctions.calculateAllWeights();
        });
        $(document).on('change', '#box_item_list [name$="-unit_type"]', function() {
            const selectedValue = $(this).val();
            console.log("Unit type changed to:", selectedValue);
            $(this).closest('tr').attr('data-unit-type', selectedValue);
        });
    });
</script>
