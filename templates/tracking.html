{% extends "homebase.html" %}
{% load static %}
{% block content %}
<!-- Hero Section -->
<section
class="relative min-h-[30vh] sm:min-h-[40vh] lg:min-h-[50vh] text-white bg-cover bg-center sm:bg-top flex flex-col justify-end"
style="
  background-image: linear-gradient(
      rgba(81, 63, 101, 0.5),
      rgba(4, 0, 12, 0.9)
    ),
    url('{% static 'images/home/bg.png' %}');
"
id="home"
>
<div class="container mx-auto text-center px-3 sm:px-6 lg:px-14 max-w-7xl pb-6 sm:pb-8 lg:pb-16">
  <h1 class="text-lg sm:text-2xl md:text-3xl lg:text-4xl xl:text-5xl font-bold mb-4 sm:mb-6 lg:mb-10 leading-tight mt-8 sm:mt-5">
    Your Shipment. Our Priority. Always on Time.
  </h1>
  <form
    class="bg-white/30 rounded-lg p-2 sm:p-4 flex flex-col sm:flex-row justify-center items-center gap-2 sm:gap-2 max-w-xs sm:max-w-lg lg:max-w-4xl mx-auto"
    method="get"
    action="{% url 'tracking' %}"
  >
    <input
      type="text"
      name="tracking_no"
      placeholder="Enter your tracking number"
      value="{{ tracking_no }}"
      class="w-full sm:flex-1 px-3 py-2 lg:py-4 rounded-md text-gray-800 focus:outline-none focus:ring-2 focus:ring-secondary text-xs sm:text-base"
      required
    />
    <button
      type="submit"
      class="w-full sm:w-auto bg-primary hover:bg-primary-dark text-white font-semibold px-4 lg:px-8 py-2 lg:py-4 rounded-md transition duration-300 text-xs sm:text-base whitespace-nowrap"
    >
      Track
    </button>
  </form>
</div>
</section>

    <!-- Tracking Section -->
    <section id="tracking" class="bg-gray-100 py-4 sm:py-8">
        <div class="max-w-6xl mx-auto px-2 sm:px-4">
            
            {% if error %}
                <!-- Error Message -->
                <div class="bg-red-50 border-l-4 border-red-500 p-3 sm:p-4 mb-4 sm:mb-6">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-triangle text-red-400"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-xs sm:text-sm text-red-700">
                                <strong>Tracking Number:</strong> {{ tracking_no }} - {{ error }}
                            </p>
                        </div>
                    </div>
                </div>
            {% endif %}

            {% if awb %}
                <!-- Timestamp Header -->
                <div class="text-center mb-3 sm:mb-4">
                    <div id="current-datetime" class="text-sm sm:text-lg font-semibold text-gray-700"></div>
                </div>

                <!-- Main Tracking Table -->
                <div class="overflow-x-auto">
                    <div class="bg-white border border-gray-300 overflow-hidden rounded-md text-xs sm:text-sm md:text-base">
                    <!-- Header Row -->
                    <div class="bg-purple-200 border-b border-gray-300">
                        <div class="grid grid-cols-1 sm:grid-cols-3 text-center py-2">
                            <div class="font-semibold text-gray-800 border-r border-gray-300 px-2">Location</div>
                            <div class="font-semibold text-gray-800 border-r border-gray-300 px-2">Time(Asia/Katmandu)</div>
                            <div class="font-semibold text-gray-800 px-2">Message</div>
                        </div>
                    </div>
                    
                    <!-- Info Row -->
                    <div class="bg-yellow-100 border-b border-gray-300">
                        <div class="grid grid-cols-3 sm:grid-cols-3 gap-1 sm:gap-0 py-3">
                            <div class="px-4 font-bold text-gray-800 text-sm sm:text-base break-words">{{ awb.awbno }}</div>
                            <div class="px-4 text-center">
                                <div class="font-semibold text-gray-800">FROM: {{ awb.origin.name|default:"Nepal" }}</div>
                            </div>
                            <div class="px-4 sm:text-right">
                                <div class="font-semibold text-gray-800">TO: {{ awb.destination.name|default:"United States of America" }}</div>
                                {% if awb.forwarding_number %}
                                    <div class="text-[11px] sm:text-sm text-gray-600 mt-1">Forwarded TO: {{ awb.forwarding_number }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Timeline Data -->
                    {% if timeline %}
                        {% for item in timeline %}
                            <div class="border-b border-gray-300 {% if forloop.counter|divisibleby:2 %}bg-gray-50{% else %}bg-white{% endif %}">
                                <div class="grid grid-cols-1 sm:grid-cols-3 py-3 gap-1 sm:gap-0">
                                    <div class="px-4 text-center font-medium text-gray-800 break-words">
                                        {{ item.location|default:"—" |safe }}
                                    </div>
                                    <div class="px-4 text-center text-gray-700">
                                        {% if item.timestamp %}
                                            <div class="leading-snug">
                                                {{ item.timestamp|date:"Y-M-j" }} | {{ item.timestamp|date:"l" }} | {{ item.timestamp|date:"H:i" }}
                                            </div>
                                        {% else %}
                                            <div>—</div>
                                        {% endif %}
                                    </div>
                                    <div class="px-4 text-center text-gray-800 break-words">
                                        {{ item.status |safe }}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <!-- No timeline data -->
                        <div class="border-b border-gray-300 bg-white">
                            <div class="grid grid-cols-1 sm:grid-cols-3 py-3 gap-1 sm:gap-0">
                                <div class="px-4 text-center font-medium text-gray-800">—</div>
                                <div class="px-4 text-center text-gray-700">
                                    {% if awb.booking_datetime %}
                                        <div class="leading-snug">{{ awb.booking_datetime|date:"Y-M-j" }} | {{ awb.booking_datetime|date:"l" }} | {{ awb.booking_datetime|date:"H:i" }}</div>
                                    {% else %}
                                        <div>—</div>
                                    {% endif %}
                                </div>
                                <div class="px-4 text-center text-gray-800">
                                    Information Received
                                </div>
                            </div>
                        </div>
                    {% endif %}
                    </div>
                </div>

                <!-- Status Information -->
                <div class="mt-4 sm:mt-6 bg-white p-3 sm:p-4 border border-gray-300">
                    <div class="flex flex-wrap gap-2 sm:gap-4 text-xs sm:text-sm">
                        {% if awb.is_verified %}
                            <span class="text-green-700 font-medium">✓ Verified</span>
                        {% endif %}
                        {% if awb.is_cancelled %}
                            <span class="text-red-700 font-medium">✗ Cancelled</span>
                        {% endif %}
                        {% if is_on_hold %}
                            <span class="text-yellow-700 font-medium">⏸ On Hold</span>
                            {% if hold_location %}
                                <span class="text-gray-600">at {{ hold_location }}</span>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            {% endif %}

            <!-- Contact Information -->
            <div class="mt-6 sm:mt-8 bg-blue-50 border border-blue-200 p-3 sm:p-4 text-center">
                <div class="text-xs sm:text-sm text-blue-700">
                    <strong>Need help?</strong> Contact us at +977-985-1168433 or shipglobalnpl@gmail.com • Available 24/7
                </div>
            </div>
        </div>
    </section>

    <script>
        // Current Date and Time functionality
        function updateDateTime() {
            const now = new Date();
            
            // Convert to Nepal time
            const nepalTime = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Katmandu"}));
            
            // Format as YYYY:MM:DD HH:MM:SS
            const year = nepalTime.getFullYear();
            const month = String(nepalTime.getMonth() + 1).padStart(2, '0');
            const day = String(nepalTime.getDate()).padStart(2, '0');
            const hours = String(nepalTime.getHours()).padStart(2, '0');
            const minutes = String(nepalTime.getMinutes()).padStart(2, '0');
            const seconds = String(nepalTime.getSeconds()).padStart(2, '0');
            
            const formattedDateTime = `${year}:${month}:${day} ${hours}:${minutes}:${seconds} Asia/Katmandu`;
            
            // Display the formatted date and time
            const datetimeElement = document.getElementById('current-datetime');
            if (datetimeElement) {
                datetimeElement.textContent = formattedDateTime;
            }
        }
        
        // Update time immediately and then every second
        updateDateTime();
        setInterval(updateDateTime, 1000);
    </script>
{% endblock content %}
